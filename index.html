  var buttons = document.querySelectorAll('.payment-btn');
  for (var i = 0; i < buttons.length; i++) {
    buttons[i].classList.remove('selected');
    buttons[i].classList.remove('card-selected');
  }
  
  event.target.closest('.payment-btn').classList.add('selected');
  
  var receivedSection = document.getElementById('receivedSection');
  
  var existingCardDisplay = document.querySelector('.card-total-display');
  if (existingCardDisplay) {
    existingCardDisplay.remove();
  }
  
  if (method === 'Cash') {
    receivedSection.classList.add('show');
    document.getElementById('receivedInput').style.display = 'block';
  } else if (method === 'Card/PIX') {
    receivedSection.classList.add('show');
    document.getElementById('receivedInput').style.display = 'none';
    document.getElementById('changeAmount').style.display = 'none';
    
    event.target.closest('.payment-btn').classList.add('card-selected');
    
    var cardDisplay = document.createElement('div');
    cardDisplay.className = 'card-total-display';
    cardDisplay.textContent = 'Total: R$ ' + total.toFixed(2).replace('.', ',');
    receivedSection.appendChild(cardDisplay);
  }
}

function processNext() {
  if (cart.length === 0) {
    showNotification('Adicione itens ao carrinho', 'warning');
    return;
  }
  
  if (!paymentMethod) {
    showNotification('Selecione um m√©todo de pagamento', 'warning');
    return;
  }
  
  var changeValue = 0;
  
  if (paymentMethod === 'Cash') {
    var receivedValue = document.getElementById('receivedInput').value;
    if (!receivedValue) {
      showNotification('Informe o valor recebido', 'warning');
      return;
    }
    
    var received = parseFloat(receivedValue.replace('R$ ', '').replace(',', '.'));
    if (received < total) {
      showNotification('Valor recebido √© insuficiente', 'error');
      return;
    }
    changeValue = received - total;
  }
  
  var sale = {
    time: new Date().toLocaleTimeString('pt-BR'),
    date: new Date().toLocaleDateString('pt-BR'),
    items: cart.slice(),
    total: total,
    payment: paymentMethod,
    received: paymentMethod === 'Cash' ? receivedAmount : total,
    change: changeValue,
    type: 'sale'
  };
  
  var turnData = getCurrentTurnData();
  turnData.history.push(sale);
  
  if (paymentMethod === 'Cash') {
    turnData.totalCash += total;
  } else {
    turnData.totalCard += total;
  }
  
  saveToLocalStorage();
  
  var sheetData = {
    type: 'sale',
    date: sale.date,
    time: sale.time,
    turn: currentTurn.type === 'morning' ? 'Manh√£' : 'Tarde',
    details: sale.items,
    total: sale.total,
    payment: paymentMethod === 'Cash' ? 'Dinheiro' : 'Cart√£o/PIX'
  };
  
  addToSyncQueue(sheetData);
  
  showNotification('Venda registrada com sucesso!', 'success');
  
  clearCart();
}

function clearCart() {
  cart = [];
  total = 0;
  paymentMethod = '';
  receivedAmount = 0;
  
  var buttons = document.querySelectorAll('.payment-btn');
  for (var i = 0; i < buttons.length; i++) {
    buttons[i].classList.remove('selected');
    buttons[i].classList.remove('card-selected');
  }
  
  var existingCardDisplay = document.querySelector('.card-total-display');
  if (existingCardDisplay) {
    existingCardDisplay.remove();
  }
  
  document.getElementById('receivedSection').classList.remove('show');
  document.getElementById('receivedInput').value = '';
  document.getElementById('receivedInput').style.display = 'block';
  document.getElementById('changeAmount').style.display = 'none';
  
  updateCart();
}

function openPaymentModal() {
  document.getElementById('paymentModal').classList.add('show');
  document.getElementById('supplierName').value = '';
  document.getElementById('paymentValue').value = '';
  document.getElementById('paymentTypeCash').checked = false;
  document.getElementById('paymentTypeExternal').checked = false;
  document.getElementById('paymentTypeMixed').checked = false;
  document.getElementById('mixedPaymentSection').style.display = 'none';
  document.getElementById('cashBalanceInfo').style.display = 'none';
  document.getElementById('mixedCashValue').value = '';
  document.getElementById('mixedExternalValue').value = '';
  document.getElementById('mixedTotal').textContent = 'R$ 0,00';
  document.getElementById('mixedWarning').style.display = 'none';
  currentPaymentType = '';
  mixedCashAmount = 0;
  mixedExternalAmount = 0;
  
  var cashBalance = getCashBalance();
  document.getElementById('currentCashBalance').textContent = 'R$ ' + cashBalance.toFixed(2).replace('.', ',');
}

function closePaymentModal() {
  document.getElementById('paymentModal').classList.remove('show');
}

function submitPayment(e) {
  e.preventDefault();
  
  var supplierName = document.getElementById('supplierName').value;
  var paymentValueStr = document.getElementById('paymentValue').value;
  
  if (!paymentValueStr) {
    showNotification('Informe o valor do pagamento', 'warning');
    return;
  }
  
  if (!currentPaymentType) {
    showNotification('Selecione a forma de pagamento', 'warning');
    return;
  }
  
  var paymentValue = parseFloat(paymentValueStr.replace('R$ ', '').replace(',', '.'));
  var cashBalance = getCashBalance();
  
  var fromCashAmount = 0;
  var externalAmount = 0;
  
  if (currentPaymentType === 'cash') {
    fromCashAmount = paymentValue;
    externalAmount = 0;
    
    if (paymentValue > cashBalance) {
      showNotification('Valor insuficiente no caixa! Saldo dispon√≠vel: R$ ' + cashBalance.toFixed(2).replace('.', ','), 'error');
      return;
    }
    
  } else if (currentPaymentType === 'external') {
    fromCashAmount = 0;
    externalAmount = paymentValue;
    
  } else if (currentPaymentType === 'mixed') {
    fromCashAmount = mixedCashAmount;
    externalAmount = mixedExternalAmount;
    
    if (fromCashAmount === 0 && externalAmount === 0) {
      showNotification('Preencha os valores do pagamento misto', 'warning');
      return;
    }
    
    var totalMixed = fromCashAmount + externalAmount;
    if (Math.abs(totalMixed - paymentValue) > 0.01) {
      showNotification('A soma dos valores (R$ ' + totalMixed.toFixed(2).replace('.', ',') + ') n√£o corresponde ao total (R$ ' + paymentValue.toFixed(2).replace('.', ',') + ')', 'error');
      return;
    }
    
    if (fromCashAmount > cashBalance) {
      showNotification('Valor do caixa insuficiente! Saldo dispon√≠vel: R$ ' + cashBalance.toFixed(2).replace('.', ','), 'error');
      return;
    }
  }
  
  var payment = {
    time: new Date().toLocaleTimeString('pt-BR'),
    date: new Date().toLocaleDateString('pt-BR'),
    supplier: supplierName,
    value: paymentValue,
    fromCashAmount: fromCashAmount,
    externalAmount: externalAmount,
    paymentType: currentPaymentType,
    type: 'payment'
  };
  
  var turnData = getCurrentTurnData();
  turnData.history.push(payment);
  
  if (fromCashAmount > 0) {
    turnData.totalPaymentsCash += fromCashAmount;
  }
  if (externalAmount > 0) {
    turnData.totalPaymentsExternal += externalAmount;
  }
  
  saveToLocalStorage();
  
  var sheetData = {
    type: 'payment',
    date: payment.date,
    time: payment.time,
    turn: currentTurn.type === 'morning' ? 'Manh√£' : 'Tarde',
    details: {
      supplier: supplierName,
      paymentType: currentPaymentType,
      fromCashAmount: fromCashAmount,
      externalAmount: externalAmount
    },
    total: paymentValue,
    supplier: supplierName
  };
  
  addToSyncQueue(sheetData);
  
  closePaymentModal();
  
  var successMsg = 'Pagamento registrado com sucesso!';
  showNotification(successMsg, 'success');
}

function openWithdrawalModal() {
  document.getElementById('withdrawalModal').classList.add('show');
  document.getElementById('withdrawalValue').value = '';
  document.getElementById('withdrawalReason').value = '';
}

function closeWithdrawalModal() {
  document.getElementById('withdrawalModal').classList.remove('show');
}

function submitWithdrawal(e) {
  e.preventDefault();
  
  var withdrawalValueStr = document.getElementById('withdrawalValue').value;
  var withdrawalReason = document.getElementById('withdrawalReason').value;
  
  if (!withdrawalValueStr) {
    showNotification('Informe o valor da sangria', 'warning');
    return;
  }
  
  var withdrawalValue = parseFloat(withdrawalValueStr.replace('R$ ', '').replace(',', '.'));
  
  var cashBalance = getCashBalance();
  if (withdrawalValue > cashBalance) {
    showNotification('Valor insuficiente no caixa! Saldo dispon√≠vel: R$ ' + cashBalance.toFixed(2).replace('.', ','), 'error');
    return;
  }
  
  var withdrawal = {
    time: new Date().toLocaleTimeString('pt-BR'),
    date: new Date().toLocaleDateString('pt-BR'),
    value: withdrawalValue,
    reason: withdrawalReason || 'N√£o informado',
    type: 'withdrawal'
  };
  
  var turnData = getCurrentTurnData();
  turnData.history.push(withdrawal);
  turnData.totalWithdrawals += withdrawalValue;
  
  saveToLocalStorage();
  
  var sheetData = {
    type: 'withdrawal',
    date: withdrawal.date,
    time: withdrawal.time,
    turn: currentTurn.type === 'morning' ? 'Manh√£' : 'Tarde',
    total: withdrawalValue,
    reason: withdrawalReason || 'N√£o informado'
  };
  
  addToSyncQueue(sheetData);
  
  closeWithdrawalModal();
  showNotification('Sangria registrada com sucesso!', 'success');
}

function printReceipt(saleIndex) {
  var turnData = getCurrentTurnData();
  var sale = turnData.history[saleIndex];
  
  if (!sale || sale.type !== 'sale') return;
  
  var receiptHTML = '<div class="print-receipt">';
  receiptHTML += '<div class="receipt-header">';
  receiptHTML += '<div class="receipt-title">PADARIA FREITAS</div>';
  receiptHTML += '<div style="font-size:11px;margin-top:5px">CUPOM N√ÉO FISCAL</div>';
  receiptHTML += '<div style="font-size:10px;margin-top:8px">' + sale.date + ' - ' + sale.time + '</div>';
  receiptHTML += '</div>';
  
  receiptHTML += '<div class="receipt-items">';
  for (var i = 0; i < sale.items.length; i++) {
    var item = sale.items[i];
    receiptHTML += '<div class="receipt-item">';
    receiptHTML += '<span>' + item.quantity + 'x ' + item.name + '</span>';
    receiptHTML += '<span>R$ ' + item.total.toFixed(2).replace('.', ',') + '</span>';
    receiptHTML += '</div>';
  }
  receiptHTML += '</div>';
  
  receiptHTML += '<div class="receipt-total">';
  receiptHTML += '<div style="display:flex;justify-content:space-between;margin:5px 0">';
  receiptHTML += '<span>TOTAL:</span>';
  receiptHTML += '<span>R$ ' + sale.total.toFixed(2).replace('.', ',') + '</span>';
  receiptHTML += '</div>';
  
  if (sale.payment === 'Cash') {
    receiptHTML += '<div style="display:flex;justify-content:space-between;margin:5px 0;font-size:12px">';
    receiptHTML += '<span>Pagamento:</span>';
    receiptHTML += '<span>DINHEIRO</span>';
    receiptHTML += '</div>';
    receiptHTML += '<div style="display:flex;justify-content:space-between;margin:5px 0;font-size:12px">';
    receiptHTML += '<span>Valor Recebido:</span>';
    receiptHTML += '<span>R$ ' + sale.received.toFixed(2).replace('.', ',') + '</span>';
    receiptHTML += '</div>';
    receiptHTML += '<div style="display:flex;justify-content:space-between;margin:5px 0;font-size:12px">';
    receiptHTML += '<span>Troco:</span>';
    receiptHTML += '<span>R$ ' + sale.change.toFixed(2).replace('.', ',') + '</span>';
    receiptHTML += '</div>';
  } else {
    receiptHTML += '<div style="display:flex;justify-content:space-between;margin:5px 0;font-size:12px">';
    receiptHTML += '<span>Pagamento:</span>';
    receiptHTML += '<span>CART√ÉO/PIX</span>';
    receiptHTML += '</div>';
  }
  receiptHTML += '</div>';
  
  receiptHTML += '<div class="receipt-footer">';
  receiptHTML += '<div>Obrigado pela prefer√™ncia!</div>';
  receiptHTML += '<div style="margin-top:5px">Volte sempre!</div>';
  receiptHTML += '</div>';
  receiptHTML += '</div>';
  
  var printArea = document.getElementById('printArea');
  printArea.innerHTML = receiptHTML;
  printArea.style.display = 'block';
  
  window.print();
  
  setTimeout(function() {
    printArea.style.display = 'none';
    printArea.innerHTML = '';
  }, 100);
}

function openHistoryModal() {
  document.getElementById('historyModal').classList.add('show');
  updateHistoryDisplay();
}

function closeHistoryModal() {
  document.getElementById('historyModal').classList.remove('show');
}

function updateHistoryDisplay() {
  var turnData = getCurrentTurnData();
  
  document.getElementById('historyCash').textContent = 'R$ ' + turnData.totalCash.toFixed(2).replace('.', ',');
  document.getElementById('historyCard').textContent = 'R$ ' + turnData.totalCard.toFixed(2).replace('.', ',');
  document.getElementById('historyPaymentsCash').textContent = 'R$ ' + turnData.totalPaymentsCash.toFixed(2).replace('.', ',');
  document.getElementById('historyPaymentsExternal').textContent = 'R$ ' + turnData.totalPaymentsExternal.toFixed(2).replace('.', ',');
  document.getElementById('historyWithdrawals').textContent = 'R$ ' + turnData.totalWithdrawals.toFixed(2).replace('.', ',');
  
  var totalSales = turnData.totalCash + turnData.totalCard;
  document.getElementById('historyTotal').textContent = 'R$ ' + totalSales.toFixed(2).replace('.', ',');
  
  var cashBalance = getCashBalance();
  document.getElementById('historyCashBalance').textContent = 'R$ ' + cashBalance.toFixed(2).replace('.', ',');
  
  var historyList = document.getElementById('historyList');
  
  if (turnData.history.length === 0) {
    historyList.innerHTML = '<div class="empty-cart"><i class="fas fa-history"></i><p>Nenhuma movimenta√ß√£o registrada</p></div>';
  } else {
    var html = '';
    for (var i = turnData.history.length - 1; i >= 0; i--) {
      var item = turnData.history[i];
      
      if (item.type === 'sale') {
        html += '<div class="history-card cash">';
        html += '<div class="history-header">';
        html += '<span class="history-time"><i class="fas fa-clock"></i> ' + item.time + '</span>';
        html += '<span class="history-payment ' + (item.payment === 'Cash' ? 'cash' : 'card') + '">';
        html += '<i class="fas fa-' + (item.payment === 'Cash' ? 'money-bill-wave' : 'credit-card') + '"></i> ';
        html += (item.payment === 'Cash' ? 'Dinheiro' : 'Cart√£o/PIX');
        html += '</span></div>';
        
        for (var j = 0; j < item.items.length; j++) {
          var prod = item.items[j];
          html += '<div class="history-item">';
          html += '<span>' + prod.quantity + 'x ' + prod.name + '</span>';
          html += '<span>R$ ' + prod.total.toFixed(2).replace('.', ',') + '</span>';
          html += '</div>';
        }
        
        html += '<div class="history-total">';
        html += '<span>TOTAL</span>';
        html += '<span>R$ ' + item.total.toFixed(2).replace('.', ',') + '</span>';
        html += '</div>';
        html += '<button class="btn-print" onclick="printReceipt(' + i + ')">';
        html += '<i class="fas fa-print"></i> Imprimir Cupom';
        html += '</button>';
        html += '</div>';
        
      } else if (item.type === 'payment') {
        html += '<div class="history-card payment" style="margin-bottom:10px">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
        html += '<span style="font-size:.8rem;color:#6c757d">';
        html += '<i class="fas fa-calendar"></i> ' + item.date + ' - ' + item.time;
        html += ' <span style="background:rgba(74,26,46,.1);padding:2px 8px;border-radius:6px;margin-left:6px">' + item.turn + '</span>';
        html += '</span>';
        html += '</div>';
        html += '<div style="font-size:.85rem;margin-bottom:6px;color:#6c757d">';
        html += '<i class="fas fa-store"></i> ' + item.supplier;
        html += '</div>';
        html += '<div style="display:flex;justify-content:space-between;font-weight:700;color:#E53935">';
        html += '<span>üì§ PAGAMENTO</span>';
        html += '<span>R$ ' + item.value.toFixed(2).replace('.', ',') + '</span>';
        html += '</div>';
        html += '</div>';
        
      } else if (item.type === 'withdrawal') {
        html += '<div class="history-card withdrawal" style="margin-bottom:10px">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
        html += '<span style="font-size:.8rem;color:#6c757d">';
        html += '<i class="fas fa-calendar"></i> ' + item.date + ' - ' + item.time;
        html += ' <span style="background:rgba(74,26,46,.1);padding:2px 8px;border-radius:6px;margin-left:6px">' + item.turn + '</span>';
        html += '</span>';
        html += '</div>';
        html += '<div style="font-size:.85rem;margin-bottom:6px;color:#6c757d">';
        html += item.reason;
        html += '</div>';
        html += '<div style="display:flex;justify-content:space-between;font-weight:700;color:#E53935">';
        html += '<span>üí∏ SANGRIA</span>';
        html += '<span>R$ ' + item.value.toFixed(2).replace('.', ',') + '</span>';
        html += '</div>';
        html += '</div>';
      }
    });
    
    html += '</div>';
  } else {
    html += '<div style="text-align:center;padding:40px;color:#6c757d">';
    html += '<i class="fas fa-inbox" style="font-size:2.5rem;opacity:.3;margin-bottom:12px;display:block"></i>';
    html += '<p>Nenhuma transa√ß√£o no per√≠odo</p>';
    html += '</div>';
  }
  
  reportContent.innerHTML = html;
}

function parseDate(dateStr, timeStr) {
  var parts = dateStr.split('/');
  var timeParts = timeStr.split(':');
  return new Date(
    parseInt('20' + parts[2]),
    parseInt(parts[1]) - 1,
    parseInt(parts[0]),
    parseInt(timeParts[0]),
    parseInt(timeParts[1]),
    parseInt(timeParts[2] || 0)
  );
}

function showNotification(message, type) {
  var notification = document.getElementById('notification');
  var messageEl = document.getElementById('notificationMessage');
  var icon = notification.querySelector('.notification-icon');
  
  messageEl.textContent = message;
  
  notification.className = 'notification ' + type;
  
  if (type === 'error') {
    icon.className = 'notification-icon fas fa-exclamation-circle';
  } else if (type === 'warning') {
    icon.className = 'notification-icon fas fa-exclamation-triangle';
  } else if (type === 'success') {
    icon.className = 'notification-icon fas fa-check-circle';
  }
  
  notification.classList.add('show');
  
  setTimeout(function() {
    hideNotification();
  }, 4000);
}

function hideNotification() {
  document.getElementById('notification').classList.remove('show');
}

// Inicializa o status de sincroniza√ß√£o quando a p√°gina carrega
window.addEventListener('load', function() {
  updateSyncStatus('success', 'Pronto');
  
  // Tenta sincronizar dados pendentes a cada 30 segundos
  setInterval(function() {
    if (syncQueue.length > 0 && !isSyncing) {
      syncAllPendingData();
    }
  }, 30000);
  
  // Monitora status da conex√£o
  window.addEventListener('online', function() {
    updateSyncStatus('success', 'Online - Sincronizando...');
    if (syncQueue.length > 0) {
      syncAllPendingData();
    }
  });
  
  window.addEventListener('offline', function() {
    updateSyncStatus('offline', 'Offline - Salvando localmente');
  });
});
</script>

</body>
</html>="history-card payment">';
        html += '<div class="history-header">';
        html += '<span class="history-time"><i class="fas fa-clock"></i> ' + item.time + '</span>';
        
        if (item.paymentType === 'cash') {
          html += '<span class="badge from-cash">DO CAIXA</span>';
        } else if (item.paymentType === 'external') {
          html += '<span class="badge external">EXTERNO</span>';
        } else if (item.paymentType === 'mixed') {
          html += '<span class="badge" style="background:rgba(255,152,0,0.1);color:#FF9800">MISTO</span>';
        }
        
        html += '</div>';
        html += '<div class="history-item">';
        html += '<span><strong>Fornecedor:</strong> ' + item.supplier + '</span>';
        html += '</div>';
        
        if (item.paymentType === 'mixed') {
          html += '<div style="background:rgba(248,249,250,.8);border-radius:8px;padding:10px;margin:8px 0;border:1px solid #dee2e6">';
          html += '<div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:.85rem">';
          html += '<span>üíµ Do Caixa:</span>';
          html += '<span style="font-weight:700;color:#E53935">R$ ' + item.fromCashAmount.toFixed(2).replace('.', ',') + '</span>';
          html += '</div>';
          html += '<div style="display:flex;justify-content:space-between;font-size:.85rem">';
          html += '<span>üè¶ Externo:</span>';
          html += '<span style="font-weight:700;color:#6c757d">R$ ' + item.externalAmount.toFixed(2).replace('.', ',') + '</span>';
          html += '</div>';
          html += '</div>';
        }
        
        html += '<div class="history-total">';
        html += '<span>VALOR TOTAL</span>';
        html += '<span>R$ ' + item.value.toFixed(2).replace('.', ',') + '</span>';
        html += '</div></div>';
        
      } else if (item.type === 'withdrawal') {
        html += '<div class="history-card withdrawal">';
        html += '<div class="history-header">';
        html += '<span class="history-time"><i class="fas fa-clock"></i> ' + item.time + '</span>';
        html += '<span style="color:#E53935;font-weight:700">SANGRIA</span>';
        html += '</div>';
        html += '<div class="history-item">';
        html += '<span><strong>Motivo:</strong> ' + item.reason + '</span>';
        html += '</div>';
        html += '<div class="history-total">';
        html += '<span>VALOR RETIRADO</span>';
        html += '<span>R$ ' + item.value.toFixed(2).replace('.', ',') + '</span>';
        html += '</div></div>';
      }
    }
    historyList.innerHTML = html;
  }
}

function closeTurn() {
  if (!confirm('Deseja fechar o turno atual e voltar √† sele√ß√£o de turno?\n\nOs dados do hist√≥rico ser√£o preservados.')) {
    return;
  }
  
  cart = [];
  total = 0;
  paymentMethod = '';
  receivedAmount = 0;
  
  var existingCardDisplay = document.querySelector('.card-total-display');
  if (existingCardDisplay) {
    existingCardDisplay.remove();
  }
  
  document.getElementById('receivedSection').classList.remove('show');
  document.getElementById('receivedInput').value = '';
  document.getElementById('receivedInput').style.display = 'block';
  document.getElementById('changeAmount').style.display = 'none';
  
  updateCart();
  
  document.getElementById('mainApp').classList.remove('show');
  document.getElementById('turnSelection').style.display = 'flex';
}

function openReportsModal() {
  document.getElementById('reportsModal').classList.add('show');
}

function closeReportsModal() {
  document.getElementById('reportsModal').classList.remove('show');
}

function showReport(period) {
  var reportContent = document.getElementById('reportContent');
  var allHistory = [];
  
  allHistory = allHistory.concat(turnsData.morning.history.map(function(item) {
    return Object.assign({}, item, {turn: 'Manh√£'});
  }));
  allHistory = allHistory.concat(turnsData.afternoon.history.map(function(item) {
    return Object.assign({}, item, {turn: 'Tarde'});
  }));
  
  allHistory.sort(function(a, b) {
    var dateA = parseDate(a.date, a.time);
    var dateB = parseDate(b.date, b.time);
    return dateB - dateA;
  });
  
  var now = new Date();
  var filtered = allHistory.filter(function(item) {
    var itemDate = parseDate(item.date, item.time);
    
    if (period === 'today') {
      return itemDate.toDateString() === now.toDateString();
    } else if (period === 'week') {
      var weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      return itemDate >= weekAgo;
    } else if (period === 'month') {
      var monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      return itemDate >= monthAgo;
    }
    return false;
  });
  
  var totals = {
    sales: 0,
    cash: 0,
    card: 0,
    payments: 0,
    withdrawals: 0,
    salesCount: 0
  };
  
  filtered.forEach(function(item) {
    if (item.type === 'sale') {
      totals.sales += item.total;
      totals.salesCount++;
      if (item.payment === 'Cash') {
        totals.cash += item.total;
      } else {
        totals.card += item.total;
      }
    } else if (item.type === 'payment') {
      totals.payments += item.value;
    } else if (item.type === 'withdrawal') {
      totals.withdrawals += item.value;
    }
  });
  
  var periodName = period === 'today' ? 'Hoje' : period === 'week' ? '√öltimos 7 dias' : '√öltimos 30 dias';
  
  var html = '<div class="summary-box" style="margin-bottom:20px">';
  html += '<h4 style="font-weight:800;margin-bottom:16px;color:#4a1a2e;text-align:center;font-size:1.2rem">';
  html += '<i class="fas fa-calendar-check"></i> ' + periodName;
  html += '</h4>';
  
  html += '<div class="summary-row">';
  html += '<span><i class="fas fa-shopping-cart"></i> Total de Vendas:</span>';
  html += '<strong style="color:#4a1a2e;font-size:1.1rem">R$ ' + totals.sales.toFixed(2).replace('.', ',') + '</strong>';
  html += '</div>';
  
  html += '<div class="summary-row">';
  html += '<span><i class="fas fa-receipt"></i> Quantidade de Vendas:</span>';
  html += '<strong style="color:#4a1a2e">' + totals.salesCount + ' vendas</strong>';
  html += '</div>';
  
  html += '<div style="border-top:2px solid rgba(74,26,46,.2);margin:12px 0;padding-top:12px">';
  
  html += '<div class="summary-row" style="margin-bottom:8px">';
  html += '<span><i class="fas fa-money-bill-wave"></i> Dinheiro:</span>';
  html += '<strong style="color:#28a745">R$ ' + totals.cash.toFixed(2).replace('.', ',') + '</strong>';
  html += '</div>';
  
  html += '<div class="summary-row" style="margin-bottom:8px">';
  html += '<span><i class="fas fa-credit-card"></i> Cart√£o/PIX:</span>';
  html += '<strong style="color:#007bff">R$ ' + totals.card.toFixed(2).replace('.', ',') + '</strong>';
  html += '</div>';
  
  html += '</div>';
  
  html += '<div style="border-top:2px solid rgba(229,57,53,.2);margin:12px 0;padding-top:12px">';
  
  html += '<div class="summary-row" style="margin-bottom:8px">';
  html += '<span><i class="fas fa-hand-holding-usd"></i> Pagamentos:</span>';
  html += '<strong style="color:#E53935">R$ ' + totals.payments.toFixed(2).replace('.', ',') + '</strong>';
  html += '</div>';
  
  html += '<div class="summary-row">';
  html += '<span><i class="fas fa-money-bill-wave"></i> Sangrias:</span>';
  html += '<strong style="color:#E53935">R$ ' + totals.withdrawals.toFixed(2).replace('.', ',') + '</strong>';
  html += '</div>';
  
  html += '</div>';
  
  var netCash = totals.cash - totals.payments - totals.withdrawals;
  html += '<div class="summary-row total" style="background:rgba(40,167,69,.1);border-radius:8px;padding:12px">';
  html += '<span><i class="fas fa-wallet"></i> Saldo L√≠quido em Caixa:</span>';
  html += '<strong style="color:#28a745;font-size:1.2rem">R$ ' + netCash.toFixed(2).replace('.', ',') + '</strong>';
  html += '</div>';
  
  html += '</div>';
  
  if (filtered.length > 0) {
    html += '<h4 style="font-weight:800;margin-bottom:12px;color:#2c3e50">';
    html += '<i class="fas fa-list"></i> Transa√ß√µes (' + filtered.length + ')';
    html += '</h4>';
    
    html += '<div style="max-height:300px;overflow-y:auto">';
    
    filtered.forEach(function(item) {
      if (item.type === 'sale') {
        html += '<div class="history-card cash" style="margin-bottom:10px">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
        html += '<span style="font-size:.8rem;color:#6c757d">';
        html += '<i class="fas fa-calendar"></i> ' + item.date + ' - ' + item.time;
        html += ' <span style="background:rgba(74,26,46,.1);padding:2px 8px;border-radius:6px;margin-left:6px">' + item.turn + '</span>';
        html += '</span>';
        html += '<span class="history-payment ' + (item.payment === 'Cash' ? 'cash' : 'card') + '">';
        html += '<i class="fas fa-' + (item.payment === 'Cash' ? 'money-bill-wave' : 'credit-card') + '"></i> ';
        html += (item.payment === 'Cash' ? 'Dinheiro' : 'Cart√£o/PIX');
        html += '</span>';
        html += '</div>';
        html += '<div style="display:flex;justify-content:space-between;font-weight:700;color:#4a1a2e">';
        html += '<span>üí∞ VENDA</span>';
        html += '<span>R$ ' + item.total.toFixed(2).replace('.', ',') + '</span>';
        html += '</div>';
        html += '</div>';
        
      } else if (item.type === 'payment') {
        html += '<div class<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Caixa Freitas v10.0 Cloud</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;touch-action:pan-y}
body{font-family:Inter,sans-serif;background:#1a1a2e;color:#2c3e50;height:100vh;overflow:hidden;touch-action:pan-y;-webkit-touch-callout:none;-webkit-user-select:none}
button{cursor:pointer;border:none;transition:.3s;touch-action:manipulation}
button:active{transform:scale(.97)}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.turn-selection{position:fixed;inset:0;background:linear-gradient(135deg,#4a1a2e,#2d0f1c);display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;padding:20px;z-index:1000;touch-action:manipulation}
.turn-logo{width:90px;height:90px;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:2.8rem;font-weight:800;margin-bottom:24px}
.turn-title{font-size:2rem;font-weight:800;margin-bottom:12px;text-align:center}
.turn-subtitle{font-size:1.05rem;opacity:.9;margin-bottom:36px;text-align:center}
.turn-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.25);color:#fff;padding:20px 28px;border-radius:16px;font-size:1.15rem;font-weight:700;margin:0 8px;touch-action:manipulation}
#mainApp{display:none;flex-direction:column;height:100vh}
#mainApp.show{display:flex;animation:fadeIn .5s}
.header{background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;padding:12px;text-align:center}
.header h1{font-size:1.5rem;font-weight:800}
.turno-info{font-size:.8rem;background:rgba(255,255,255,.2);padding:4px 12px;border-radius:12px;margin-top:8px;display:inline-flex;gap:6px;align-items:center}
.sync-status{font-size:.75rem;background:rgba(255,255,255,.15);padding:4px 10px;border-radius:10px;margin-top:6px;display:inline-flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.2)}
.sync-status i{font-size:.85rem}
.sync-status i.fa-spin{animation:spin 1s linear infinite}
.container{max-width:420px;margin:0 auto;padding:8px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
.card{background:rgba(255,255,255,.95);border-radius:16px;padding:14px;box-shadow:0 8px 32px rgba(0,0,0,.12);animation:slideUp .5s}
.section-title{font-size:1rem;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.products-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.product-btn{background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;border-radius:12px;padding:18px 12px;font-size:.95rem;font-weight:700;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;touch-action:manipulation}
.product-btn .price{font-size:.8rem;opacity:.95}
.others-btn{background:linear-gradient(135deg,#FF9800,#F57C00)}
.summary-list{min-height:120px;max-height:150px;overflow-y:auto;margin-bottom:12px;border:1px solid #dee2e6;border-radius:12px;padding:8px;background:rgba(248,249,250,.5)}
.summary-item{display:grid;grid-template-columns:1fr auto auto;gap:10px;padding:12px;margin-bottom:6px;background:#fff;border-radius:12px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:.3s;touch-action:manipulation}
.summary-item:hover{transform:translateX(-3px)}
.summary-item.is-others{background:linear-gradient(135deg,rgba(255,249,196,.9),rgba(255,245,157,.9))}
.item-label{font-weight:700;font-size:.9rem}
.item-quantity{font-size:.8rem;color:#6c757d;margin-top:2px}
.item-price{font-weight:800;color:#4a1a2e;font-size:.95rem}
.delete-btn{background:none;color:#E53935;padding:8px;border-radius:50%;width:36px;height:36px;font-size:.9rem;touch-action:manipulation}
.delete-btn:hover{background:rgba(229,57,53,.1)}
.empty-cart{text-align:center;padding:24px;color:#6c757d}
.empty-cart i{font-size:2.5rem;opacity:.3;margin-bottom:12px;display:block}
.total-amount{font-size:1.5rem;font-weight:900;color:#4a1a2e;text-align:center;margin-bottom:14px;border:2px solid #4a1a2e;border-radius:12px;padding:12px;background:#fff}
.payment-methods{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.payment-btn{background:#fff;color:#2c3e50;border:2px solid #dee2e6;border-radius:12px;padding:14px;font-weight:700;display:flex;align-items:center;gap:8px;justify-content:center;font-size:.95rem;transition:.3s;touch-action:manipulation}
.payment-btn:hover{transform:translateY(-2px)}
.payment-btn.selected{background:linear-gradient(135deg,#28a745,#218838);color:#fff;border-color:#28a745;transform:scale(1.02)}
.payment-btn.selected.card-selected{background:linear-gradient(135deg,#007bff,#0056b3);border-color:#007bff}
.received-section{margin-bottom:14px;display:none}
.received-section.show{display:block;animation:slideUp .4s}
.received-input{width:100%;padding:14px;font-size:1.3rem;border:2px solid #F9A825;border-radius:12px;text-align:center;background:linear-gradient(135deg,rgba(255,249,196,.9),rgba(255,245,157,.9));font-weight:800;cursor:pointer;touch-action:manipulation}
.card-total-display{width:100%;padding:14px;font-size:1.3rem;border:2px solid #007bff;border-radius:12px;text-align:center;background:linear-gradient(135deg,rgba(0,123,255,.1),rgba(0,86,179,.1));font-weight:800;color:#007bff;pointer-events:none}
.change-amount{text-align:center;font-size:1.15rem;font-weight:800;color:#28a745;margin-top:10px;display:none}
.action-buttons{display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px;margin-bottom:14px}
.action-buttons-row2{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
.action-btn{padding:14px 10px;border-radius:12px;font-size:.9rem;font-weight:800;display:flex;align-items:center;justify-content:center;gap:6px;min-height:54px;transition:.3s;touch-action:manipulation}
.action-btn:hover{transform:translateY(-2px)}
.next-btn{background:linear-gradient(135deg,#28a745,#218838);color:#fff;font-size:1rem}
.clear-btn{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff}
.payment-supplier-btn{background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;font-size:.8rem}
.sangria-btn{background:linear-gradient(135deg,#FF9800,#F57C00);color:#fff;font-size:.8rem}
.close-turn-btn{background:linear-gradient(135deg,#6c757d,#424242);color:#fff;font-size:.8rem}
.history-btn{background:linear-gradient(135deg,#6c757d,#424242);color:#fff;font-size:.85rem}
.history-btn.pro{background:linear-gradient(135deg,#4a1a2e,#2d0f1c)}
.modal-overlay{position:fixed;inset:0;background:rgba(26,26,46,.95);backdrop-filter:blur(20px);padding:20px;z-index:2000;display:none;justify-content:center;align-items:center;overflow-y:auto}
.modal-overlay.show{display:flex;animation:fadeIn .4s}
.modal-content{background:#fff;border-radius:24px;padding:24px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #dee2e6}
.modal-title{font-weight:800;font-size:1.4rem;display:flex;align-items:center;gap:10px}
.modal-close{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff;font-size:1.3rem;padding:8px 12px;border-radius:10px;font-weight:bold;touch-action:manipulation}
.form-group{margin-bottom:18px}
.form-label{display:block;font-weight:700;margin-bottom:8px;font-size:.95rem}
.form-input{width:100%;padding:14px;border:2px solid #dee2e6;border-radius:12px;font-size:1rem;transition:.3s;touch-action:manipulation}
.form-input:focus{outline:none;border-color:#4a1a2e;box-shadow:0 0 0 3px rgba(74,26,46,.1)}
.form-checkbox{display:flex;align-items:center;gap:10px;padding:14px;background:#f8f9fa;border-radius:12px;border:2px solid #dee2e6;cursor:pointer;transition:.3s;touch-action:manipulation}
.form-checkbox:hover{background:#fff3cd;border-color:#FF9800}
.form-checkbox.payment-type-option{justify-content:center;transition:.3s;cursor:pointer}
.form-checkbox.payment-type-option:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
.form-checkbox.payment-type-option input:checked ~ label{color:#4a1a2e}
.form-checkbox.payment-type-option input:checked{accent-color:#4a1a2e}
.form-checkbox input{width:24px;height:24px;cursor:pointer}
.form-checkbox label{font-weight:700;flex:1;cursor:pointer}
.form-actions{display:grid;grid-template-columns:1fr 2fr;gap:12px;margin-top:24px}
.btn-cancel{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff;padding:16px;border-radius:12px;font-weight:800;font-size:1rem;touch-action:manipulation}
.btn-submit{background:linear-gradient(135deg,#28a745,#218838);color:#fff;padding:16px;border-radius:12px;font-weight:800;font-size:1rem;touch-action:manipulation}
.history-list{display:flex;flex-direction:column;gap:12px;max-height:60vh;overflow-y:auto;padding-right:8px}
.history-list::-webkit-scrollbar{width:6px}
.history-list::-webkit-scrollbar-thumb{background:#4a1a2e;border-radius:10px}
.history-card{background:#fff;border-radius:12px;padding:16px;border:2px solid #dee2e6;box-shadow:0 4px 16px rgba(0,0,0,.1);animation:slideUp .4s}
.history-card.cash{border-left:4px solid #28a745;background:rgba(40,167,69,0.03)}
.history-card.payment{border-left:4px solid #ff6b6b;background:rgba(255,107,107,0.05)}
.history-card.withdrawal{border-left:4px solid #ff6b6b;background:rgba(255,107,107,0.05)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:.75rem;font-weight:700;margin-top:8px}
.badge.from-cash{background:rgba(229,57,53,0.1);color:#E53935}
.badge.external{background:rgba(40,167,69,0.1);color:#28a745}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #dee2e6}
.history-time{font-weight:700;font-size:1rem}
.history-payment{display:flex;align-items:center;gap:6px;font-weight:700;padding:6px 12px;border-radius:8px;font-size:.85rem}
.history-payment.cash{background:rgba(40,167,69,.1);color:#28a745}
.history-payment.card{background:rgba(0,123,255,.1);color:#007bff}
.history-item{display:flex;justify-content:space-between;padding:6px 0;font-size:.9rem;color:#6c757d}
.history-total{display:flex;justify-content:space-between;padding-top:12px;border-top:2px solid #dee2e6;font-weight:900;font-size:1.1rem;color:#4a1a2e;margin-top:8px}
.btn-print{background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;padding:10px 16px;border-radius:8px;font-weight:700;margin-top:12px;display:flex;align-items:center;justify-content:center;gap:6px;width:100%;touch-action:manipulation}
.btn-print:hover{transform:translateY(-2px)}
.summary-box{background:linear-gradient(135deg,rgba(74,26,46,.1),rgba(107,40,67,.1));border-radius:12px;padding:16px;margin-bottom:20px;border:2px solid rgba(74,26,46,.3)}
.summary-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:1rem;align-items:center}
.summary-row.total{font-size:1.3rem;font-weight:900;color:#4a1a2e;padding-top:10px;border-top:2px solid rgba(74,26,46,.3);margin-top:10px}
.virtual-keyboard{position:fixed;inset:0;background:rgba(26,26,46,.95);backdrop-filter:blur(20px);padding:20px;z-index:3000;display:none;justify-content:center;align-items:center}
.virtual-keyboard.show{display:flex;animation:fadeIn .4s}
.keyboard-container{background:#fff;border-radius:24px;padding:24px;width:100%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.keyboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #dee2e6}
.keyboard-title{font-weight:800;font-size:1.15rem}
.keyboard-close{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff;font-size:1.3rem;padding:8px 12px;border-radius:10px;font-weight:bold;touch-action:manipulation}
.keyboard-display{background:linear-gradient(135deg,rgba(255,249,196,.9),rgba(255,245,157,.9));padding:18px;border-radius:12px;font-size:2rem;font-weight:900;text-align:center;margin-bottom:20px;border:3px solid #F9A825;min-height:75px;display:flex;align-items:center;justify-content:center;color:#4a1a2e}
.keyboard-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.keyboard-btn{aspect-ratio:1;font-size:1.5rem;font-weight:800;border-radius:12px;background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;min-height:64px;display:flex;align-items:center;justify-content:center;transition:.3s;touch-action:manipulation}
.keyboard-btn:hover{transform:translateY(-2px)}
.keyboard-btn:active{transform:scale(.95)}
.keyboard-actions{display:grid;grid-template-columns:1fr 2fr;gap:12px}
.keyboard-cancel,.keyboard-confirm{border-radius:12px;padding:18px;font-weight:800;font-size:1.05rem;touch-action:manipulation}
.keyboard-cancel{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff}
.keyboard-confirm{background:linear-gradient(135deg,#28a745,#218838);color:#fff}
.notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#fff;border-radius:16px;padding:18px 24px;box-shadow:0 8px 32px rgba(0,0,0,.2);z-index:3000;display:none;align-items:center;gap:14px;min-width:300px;max-width:90%}
.notification.show{display:flex;animation:slideUp .5s}
.notification.error{border-left:4px solid #E53935;background:rgba(253,242,242,.98)}
.notification.warning{border-left:4px solid #FF9800;background:rgba(255,251,240,.98)}
.notification.success{border-left:4px solid #28a745;background:rgba(232,245,233,.98)}
.notification-icon{font-size:1.5rem}
.notification.error .notification-icon{color:#E53935}
.notification.warning .notification-icon{color:#FF9800}
.notification.success .notification-icon{color:#28a745}
.notification-message{flex:1;font-weight:700;font-size:1rem}
.notification-close{background:none;font-size:1.2rem;color:#6c757d;padding:6px;touch-action:manipulation}
@media print{body *{visibility:hidden}#printArea,#printArea *{visibility:visible}#printArea{position:absolute;left:0;top:0;width:100%}}
.print-receipt{font-family:monospace;max-width:300px;margin:0 auto;padding:20px;background:#fff}
.receipt-header{text-align:center;border-bottom:2px dashed #000;padding-bottom:10px;margin-bottom:10px}
.receipt-title{font-size:18px;font-weight:bold;margin-bottom:5px}
.receipt-items{border-bottom:2px dashed #000;padding-bottom:10px;margin-bottom:10px}
.receipt-item{display:flex;justify-content:space-between;margin:5px 0;font-size:12px}
.receipt-total{font-weight:bold;font-size:14px;margin-top:10px}
.receipt-footer{text-align:center;margin-top:10px;padding-top:10px;border-top:2px dashed #000;font-size:11px}
</style>
</head>
<body>

<div class="turn-selection" id="turnSelection">
<div class="turn-logo">F</div>
<h2 class="turn-title">Bem-vindo ao Caixa Freitas</h2>
<p class="turn-subtitle">Selecione o turno para come√ßar</p>
<div>
<button class="turn-btn" onclick="startTurn('morning')">‚òÄÔ∏è Turno da Manh√£</button>
<button class="turn-btn" onclick="startTurn('afternoon')">üåÖ Turno da Tarde</button>
</div>
</div>

<div id="mainApp">
<header class="header">
<h1>Caixa Freitas Cloud</h1>
<div class="turno-info">
<i class="fas fa-clock"></i>
<span id="turnText">Carregando...</span>
</div>
<div class="sync-status">
<i class="fas fa-cloud" id="syncIcon"></i>
<span id="syncText">Iniciando...</span>
</div>
</header>

<div class="container">
<section class="card">
<h3 class="section-title"><i class="fas fa-bread-slice"></i> Produtos</h3>
<div class="products-grid">
<button class="product-btn" onclick="addProduct('P√£o de Sal', 0.70)">
<span>P√£o de Sal</span>
<span class="price">R$ 0,70</span>
</button>
<button class="product-btn" onclick="addProduct('P√£o Doce Comum', 0.70)">
<span>P√£o Doce Comum</span>
<span class="price">R$ 0,70</span>
</button>
<button class="product-btn" onclick="addProduct('P√£o Doce Especial', 0.80)">
<span>P√£o Doce Especial</span>
<span class="price">R$ 0,80</span>
</button>
<button class="product-btn others-btn" onclick="openKeyboard('others')">
<span>Outros</span>
</button>
</div>
</section>

<section class="card">
<h3 class="section-title"><i class="fas fa-shopping-cart"></i> Pedido</h3>
<div class="summary-list" id="summaryList">
<div class="empty-cart">
<i class="fas fa-shopping-cart"></i>
<p>Nenhum item adicionado</p>
</div>
</div>

<div class="total-amount" id="totalAmountDiv">
Total: <span id="totalAmount">R$ 0,00</span>
</div>

<h4 class="section-title"><i class="fas fa-credit-card"></i> Pagamento</h4>
<div class="payment-methods">
<button class="payment-btn" onclick="selectPayment('Cash')">
<i class="fas fa-money-bill-wave"></i> Dinheiro
</button>
<button class="payment-btn" onclick="selectPayment('Card/PIX')">
<i class="fas fa-credit-card"></i> Cart√£o/PIX
</button>
</div>

<div class="received-section" id="receivedSection">
<input type="text" class="received-input" id="receivedInput" 
placeholder="Valor recebido" readonly onclick="openReceivedKeyboard()">
<div class="change-amount" id="changeAmount"></div>
</div>

<div class="action-buttons">
<button class="action-btn next-btn" onclick="processNext()">
<i class="fas fa-check"></i> Pr√≥ximo Cliente
</button>
<button class="action-btn clear-btn" onclick="clearCart()">
<i class="fas fa-trash"></i> Limpar
</button>
<button class="action-btn payment-supplier-btn" onclick="openPaymentModal()">
<i class="fas fa-hand-holding-usd"></i> Pagamento
</button>
</div>

<div class="action-buttons-row2">
<button class="action-btn sangria-btn" onclick="openWithdrawalModal()">
<i class="fas fa-money-bill-wave"></i> Sangria
</button>
<button class="action-btn close-turn-btn" onclick="closeTurn()">
<i class="fas fa-times"></i> Fechar
</button>
<button class="action-btn history-btn" onclick="openHistoryModal()">
<i class="fas fa-history"></i> Hist√≥rico
</button>
<button class="action-btn history-btn pro" onclick="openReportsModal()">
<i class="fas fa-chart-line"></i> Relat√≥rios
</button>
</div>
</section>
</div>
</div>

<div class="modal-overlay" id="paymentModal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">
<i class="fas fa-hand-holding-usd"></i> Pagamento a Fornecedor
</h3>
<button class="modal-close" onclick="closePaymentModal()">√ó</button>
</div>
<form onsubmit="submitPayment(event)">
<div class="form-group">
<label class="form-label">Nome do Representante/Fornecedor</label>
<input type="text" class="form-input" id="supplierName" required placeholder="Ex: Jo√£o Silva - Padaria Central">
</div>
<div class="form-group">
<label class="form-label">Valor Total do Pagamento *</label>
<input type="text" class="form-input" id="paymentValue" required placeholder="0,00" readonly onclick="openPaymentKeyboard()">
</div>
<div class="form-group">
<label class="form-label">Forma de Pagamento *</label>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
<div class="form-checkbox payment-type-option" onclick="selectPaymentType('cash')" style="padding:12px">
<input type="radio" name="paymentType" id="paymentTypeCash" value="cash" required>
<label for="paymentTypeCash" style="font-size:.85rem;text-align:center">
üíµ Do Caixa
</label>
</div>
<div class="form-checkbox payment-type-option" onclick="selectPaymentType('external')" style="padding:12px">
<input type="radio" name="paymentType" id="paymentTypeExternal" value="external" required>
<label for="paymentTypeExternal" style="font-size:.85rem;text-align:center">
üè¶ Externo
</label>
</div>
<div class="form-checkbox payment-type-option" onclick="selectPaymentType('mixed')" style="padding:12px">
<input type="radio" name="paymentType" id="paymentTypeMixed" value="mixed" required>
<label for="paymentTypeMixed" style="font-size:.85rem;text-align:center">
üîÄ Misto
</label>
</div>
</div>
</div>

<div class="form-group" id="mixedPaymentSection" style="display:none">
<div style="background:linear-gradient(135deg,rgba(74,26,46,.1),rgba(107,40,67,.1));border-radius:12px;padding:16px;border:2px solid rgba(74,26,46,.3)">
<h4 style="font-weight:800;font-size:.95rem;margin-bottom:12px;color:#4a1a2e">
<i class="fas fa-calculator"></i> Divis√£o do Pagamento
</h4>
<div style="margin-bottom:12px">
<label class="form-label" style="font-size:.9rem">Valor do Caixa</label>
<input type="text" class="form-input" id="mixedCashValue" placeholder="0,00" readonly onclick="openMixedCashKeyboard()">
</div>
<div style="margin-bottom:12px">
<label class="form-label" style="font-size:.9rem">Valor Externo</label>
<input type="text" class="form-input" id="mixedExternalValue" placeholder="0,00" readonly onclick="openMixedExternalKeyboard()">
</div>
<div style="background:#fff;border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;border:2px solid #4a1a2e">
<span style="font-weight:700;font-size:.9rem">Total Informado:</span>
<span id="mixedTotal" style="font-weight:900;font-size:1.1rem;color:#4a1a2e">R$ 0,00</span>
</div>
<div id="mixedWarning" style="display:none;margin-top:10px;padding:10px;background:rgba(229,57,53,0.1);border-radius:8px;border:2px solid rgba(229,57,53,0.3)">
<div style="display:flex;align-items:center;gap:6px;color:#E53935;font-weight:700;font-size:.85rem">
<i class="fas fa-exclamation-triangle"></i>
<span>A soma n√£o corresponde ao valor total!</span>
</div>
</div>
</div>
</div>

<div id="cashBalanceInfo" style="display:none;background:rgba(40,167,69,0.1);padding:12px;border-radius:8px;margin-bottom:16px;border:2px solid rgba(40,167,69,0.3)">
<div style="display:flex;justify-content:space-between;align-items:center">
<span style="font-weight:700;color:#28a745">
<i class="fas fa-wallet"></i> Saldo em Caixa:
</span>
<span id="currentCashBalance" style="font-weight:900;font-size:1.1rem;color:#28a745">R$ 0,00</span>
</div>
</div>

<div class="form-actions">
<button type="button" class="btn-cancel" onclick="closePaymentModal()">Cancelar</button>
<button type="submit" class="btn-submit">
<i class="fas fa-check"></i> Registrar Pagamento
</button>
</div>
</form>
</div>
</div>

<div class="modal-overlay" id="withdrawalModal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">
<i class="fas fa-money-bill-wave"></i> Sangria - Retirada de Caixa
</h3>
<button class="modal-close" onclick="closeWithdrawalModal()">√ó</button>
</div>
<form onsubmit="submitWithdrawal(event)">
<div class="form-group">
<label class="form-label">Valor da Sangria</label>
<input type="text" class="form-input" id="withdrawalValue" required placeholder="0,00" readonly onclick="openWithdrawalKeyboard()">
</div>
<div class="form-group">
<label class="form-label">Motivo (opcional)</label>
<input type="text" class="form-input" id="withdrawalReason" placeholder="Ex: Troco, Dep√≥sito banc√°rio, etc.">
</div>
<div style="background:rgba(229,57,53,0.1);padding:12px;border-radius:8px;margin-bottom:16px;border:2px solid rgba(229,57,53,0.3)">
<div style="display:flex;align-items:center;gap:8px;color:#E53935;font-weight:700">
<i class="fas fa-exclamation-triangle"></i>
<span>Este valor ser√° abatido do caixa automaticamente</span>
</div>
</div>
<div class="form-actions">
<button type="button" class="btn-cancel" onclick="closeWithdrawalModal()">Cancelar</button>
<button type="submit" class="btn-submit">
<i class="fas fa-check"></i> Confirmar Sangria
</button>
</div>
</form>
</div>
</div>

<div class="modal-overlay" id="historyModal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">
<i class="fas fa-history"></i> Hist√≥rico do Turno
</h3>
<button class="modal-close" onclick="closeHistoryModal()">√ó</button>
</div>

<div class="summary-box">
<div class="summary-row">
<span><i class="fas fa-money-bill-wave"></i> Total em Dinheiro:</span>
<strong id="historyCash">R$ 0,00</strong>
</div>
<div class="summary-row">
<span><i class="fas fa-credit-card"></i> Total em Cart√£o/PIX:</span>
<strong id="historyCard">R$ 0,00</strong>
</div>
<div class="summary-row">
<span><i class="fas fa-hand-holding-usd"></i> Pagamentos (do caixa):</span>
<strong id="historyPaymentsCash" style="color:#E53935">R$ 0,00</strong>
</div>
<div class="summary-row">
<span><i class="fas fa-hand-holding-usd"></i> Pagamentos (externos):</span>
<strong id="historyPaymentsExternal" style="color:#6c757d">R$ 0,00</strong>
</div>
<div class="summary-row">
<span><i class="fas fa-money-bill-wave"></i> Sangrias:</span>
<strong id="historyWithdrawals" style="color:#E53935">R$ 0,00</strong>
</div>
<div class="summary-row total">
<span>üí∞ Total de Vendas:</span>
<span id="historyTotal">R$ 0,00</span>
</div>
<div class="summary-row">
<span>üíµ Dinheiro em Caixa:</span>
<strong id="historyCashBalance" style="color:#28a745">R$ 0,00</strong>
</div>
</div>

<h4 style="font-weight:800;margin-bottom:12px;color:#2c3e50">
<i class="fas fa-list"></i> Movimenta√ß√µes do Turno
</h4>
<div class="history-list" id="historyList"></div>
</div>
</div>

<div class="modal-overlay" id="reportsModal">
<div class="modal-content" style="max-width:600px">
<div class="modal-header">
<h3 class="modal-title">
<i class="fas fa-chart-line"></i> Relat√≥rios
</h3>
<button class="modal-close" onclick="closeReportsModal()">√ó</button>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px">
<button class="payment-btn" style="flex-direction:column;padding:12px" onclick="showReport('today')">
<i class="fas fa-calendar-day" style="font-size:1.3rem;margin-bottom:6px"></i>
<span style="font-size:.85rem">Hoje</span>
</button>
<button class="payment-btn" style="flex-direction:column;padding:12px" onclick="showReport('week')">
<i class="fas fa-calendar-week" style="font-size:1.3rem;margin-bottom:6px"></i>
<span style="font-size:.85rem">Semana</span>
</button>
<button class="payment-btn" style="flex-direction:column;padding:12px" onclick="showReport('month')">
<i class="fas fa-calendar-alt" style="font-size:1.3rem;margin-bottom:6px"></i>
<span style="font-size:.85rem">M√™s</span>
</button>
</div>

<div id="reportContent">
<div style="text-align:center;padding:40px;color:#6c757d">
<i class="fas fa-chart-bar" style="font-size:3rem;opacity:.3;margin-bottom:12px;display:block"></i>
<p>Selecione um per√≠odo acima</p>
</div>
</div>
</div>
</div>

<div class="virtual-keyboard" id="virtualKeyboard">
<div class="keyboard-container">
<div class="keyboard-header">
<span class="keyboard-title" id="keyboardTitle">Inserir valor</span>
<button class="keyboard-close" onclick="closeKeyboard()">√ó</button>
</div>
<div class="keyboard-display" id="keyboardDisplay">0</div>
<div class="keyboard-grid">
<button class="keyboard-btn" onclick="inputDigit('1')">1</button>
<button class="keyboard-btn" onclick="inputDigit('2')">2</button>
<button class="keyboard-btn" onclick="inputDigit('3')">3</button>
<button class="keyboard-btn" onclick="inputDigit('4')">4</button>
<button class="keyboard-btn" onclick="inputDigit('5')">5</button>
<button class="keyboard-btn" onclick="inputDigit('6')">6</button>
<button class="keyboard-btn" onclick="inputDigit('7')">7</button>
<button class="keyboard-btn" onclick="inputDigit('8')">8</button>
<button class="keyboard-btn" onclick="inputDigit('9')">9</button>
<button class="keyboard-btn" onclick="inputComma()">,</button>
<button class="keyboard-btn" onclick="inputDigit('0')">0</button>
<button class="keyboard-btn" onclick="backspace()">
<i class="fas fa-backspace"></i>
</button>
</div>
<div class="keyboard-actions">
<button class="keyboard-cancel" onclick="closeKeyboard()">Cancelar</button>
<button class="keyboard-confirm" onclick="confirmKeyboard()">Confirmar</button>
</div>
</div>
</div>

<div class="notification" id="notification">
<i class="notification-icon fas fa-exclamation-triangle"></i>
<span class="notification-message" id="notificationMessage">Mensagem</span>
<button class="notification-close" onclick="hideNotification()">√ó</button>
</div>

<div id="printArea" style="display:none"></div>

<script>
// ========== CONFIGURA√á√ÉO DO GOOGLE SHEETS ==========
var GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzraTzSEYhP0hYpN5lvTJakmhPHJ2PcAdodBdC8Tw9VbffYbP5Bri80-9CfgsLUayPn/exec';
var syncQueue = [];
var isSyncing = false;
var lastSyncTime = null;

// Vari√°veis globais
var cart = [];
var total = 0;
var paymentMethod = '';
var currentTurn = null;
var keyboardValue = '';
var keyboardTarget = null;
var editIndex = null;
var isFirstDigit = false;
var receivedAmount = 0;
var currentPaymentType = '';
var mixedCashAmount = 0;
var mixedExternalAmount = 0;

// Sistema de turnos separados - COM ARMAZENAMENTO LOCAL
var turnsData = loadFromLocalStorage() || {
  morning: {
    totalCash: 0,
    totalCard: 0,
    totalPaymentsCash: 0,
    totalPaymentsExternal: 0,
    totalWithdrawals: 0,
    history: []
  },
  afternoon: {
    totalCash: 0,
    totalCard: 0,
    totalPaymentsCash: 0,
    totalPaymentsExternal: 0,
    totalWithdrawals: 0,
    history: []
  }
};

// ========== FUN√á√ïES DE ARMAZENAMENTO LOCAL ==========
function saveToLocalStorage() {
  try {
    var dataToSave = {
      turnsData: turnsData,
      lastUpdate: new Date().toISOString()
    };
    localStorage.setItem('caixaFreitasData', JSON.stringify(dataToSave));
    return true;
  } catch (e) {
    console.error('Erro ao salvar localmente:', e);
    return false;
  }
}

function loadFromLocalStorage() {
  try {
    var saved = localStorage.getItem('caixaFreitasData');
    if (saved) {
      var data = JSON.parse(saved);
      console.log('Dados carregados do armazenamento local');
      return data.turnsData;
    }
  } catch (e) {
    console.error('Erro ao carregar dados locais:', e);
  }
  return null;
}

// ========== FUN√á√ïES DE SINCRONIZA√á√ÉO COM GOOGLE SHEETS ==========
function updateSyncStatus(status, message) {
  var syncIcon = document.getElementById('syncIcon');
  var syncText = document.getElementById('syncText');
  
  if (!syncIcon || !syncText) return;
  
  if (status === 'syncing') {
    syncIcon.className = 'fas fa-sync fa-spin';
    syncIcon.style.color = '#FF9800';
    syncText.textContent = message || 'Sincronizando...';
  } else if (status === 'success') {
    syncIcon.className = 'fas fa-check-circle';
    syncIcon.style.color = '#28a745';
    syncText.textContent = message || 'Sincronizado ‚úì';
    lastSyncTime = new Date();
  } else if (status === 'error') {
    syncIcon.className = 'fas fa-exclamation-triangle';
    syncIcon.style.color = '#E53935';
    syncText.textContent = message || 'Offline - Salvo localmente';
  } else if (status === 'offline') {
    syncIcon.className = 'fas fa-wifi-slash';
    syncIcon.style.color = '#6c757d';
    syncText.textContent = 'Offline - Salvando localmente';
  }
}

function syncToGoogleSheets(data) {
  return new Promise(function(resolve) {
    if (!navigator.onLine) {
      updateSyncStatus('offline');
      resolve({ status: 'offline', saved_locally: true });
      return;
    }
    
    updateSyncStatus('syncing');
    
    fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
    .then(function() {
      updateSyncStatus('success', 'Sincronizado ' + new Date().toLocaleTimeString('pt-BR'));
      resolve({ status: 'success' });
    })
    .catch(function(error) {
      console.error('Erro na sincroniza√ß√£o:', error);
      updateSyncStatus('error', 'Erro - Salvo localmente');
      resolve({ status: 'error', saved_locally: true });
    });
  });
}

function addToSyncQueue(data) {
  syncQueue.push(data);
  saveToLocalStorage();
  
  if (!isSyncing) {
    syncAllPendingData();
  }
}

function syncAllPendingData() {
  if (isSyncing || syncQueue.length === 0) return;
  
  isSyncing = true;
  var item = syncQueue.shift();
  
  syncToGoogleSheets(item)
    .then(function() {
      if (syncQueue.length > 0) {
        setTimeout(syncAllPendingData, 500);
      } else {
        isSyncing = false;
      }
    })
    .catch(function() {
      isSyncing = false;
    });
}

// ========== FUN√á√ïES PRINCIPAIS ==========
function getCurrentTurnData() {
  if (!currentTurn) return null;
  return turnsData[currentTurn.type];
}

function getCashBalance() {
  var turnData = getCurrentTurnData();
  if (!turnData) return 0;
  return turnData.totalCash - turnData.totalPaymentsCash - turnData.totalWithdrawals;
}

function startTurn(type) {
  try {
    var now = new Date();
    
    currentTurn = {
      type: type,
      startTime: now.toLocaleTimeString('pt-BR'),
      startDate: now.toLocaleDateString('pt-BR')
    };
    
    var turnSelection = document.getElementById('turnSelection');
    var mainApp = document.getElementById('mainApp');
    
    if (turnSelection && mainApp) {
      turnSelection.style.display = 'none';
      mainApp.classList.add('show');
      
      var turnName = type === 'morning' ? '‚òÄÔ∏è Turno da Manh√£' : 'üåÖ Turno da Tarde';
      var turnText = document.getElementById('turnText');
      if (turnText) {
        turnText.textContent = turnName + ' - ' + currentTurn.startTime;
      }
      
      updateSyncStatus('success', 'Pronto');
    }
  } catch (error) {
    console.error('Erro ao iniciar turno:', error);
    alert('Erro ao iniciar turno. Por favor, recarregue a p√°gina.');
  }
}

function addProduct(name, price) {
  var existingIndex = -1;
  for (var i = 0; i < cart.length; i++) {
    if (cart[i].name === name && !cart[i].isOther) {
      existingIndex = i;
      break;
    }
  }
  
  if (existingIndex >= 0) {
    cart[existingIndex].quantity++;
    cart[existingIndex].total = cart[existingIndex].quantity * cart[existingIndex].price;
  } else {
    cart.unshift({
      name: name,
      price: price,
      quantity: 1,
      total: price,
      isOther: false
    });
  }
  
  updateCart();
}

function editItemQuantity(index) {
  var item = cart[index];
  
  if (item.isOther) {
    editOtherItem(index);
    return;
  }
  
  editIndex = index;
  keyboardTarget = 'edit-quantity';
  keyboardValue = '0';
  isFirstDigit = true;
  
  document.getElementById('keyboardDisplay').textContent = '0';
  document.getElementById('keyboardTitle').textContent = 'Quantidade de ' + item.name;
  document.getElementById('virtualKeyboard').classList.add('show');
}

function openKeyboard(target) {
  keyboardTarget = target;
  keyboardValue = '0';
  isFirstDigit = true;
  editIndex = null;
  
  document.getElementById('keyboardDisplay').textContent = '0';
  
  if (target === 'others') {
    document.getElementById('keyboardTitle').textContent = 'Valor de "Outros"';
  }
  
  document.getElementById('virtualKeyboard').classList.add('show');
}

function openReceivedKeyboard() {
  if (!paymentMethod) {
    showNotification('Selecione um m√©todo de pagamento primeiro', 'warning');
    return;
  }
  
  if (paymentMethod !== 'Cash') {
    showNotification('Campo dispon√≠vel apenas para pagamento em dinheiro', 'warning');
    return;
  }
  
  keyboardTarget = 'received';
  keyboardValue = '0';
  isFirstDigit = true;
  document.getElementById('keyboardDisplay').textContent = '0';
  document.getElementById('keyboardTitle').textContent = 'Valor Recebido';
  document.getElementById('virtualKeyboard').classList.add('show');
}

function openPaymentKeyboard() {
  keyboardTarget = 'payment';
  keyboardValue = '0';
  isFirstDigit = true;
  document.getElementById('keyboardDisplay').textContent = '0';
  document.getElementById('keyboardTitle').textContent = 'Valor do Pagamento';
  document.getElementById('virtualKeyboard').classList.add('show');
}

function openWithdrawalKeyboard() {
  keyboardTarget = 'withdrawal';
  keyboardValue = '0';
  isFirstDigit = true;
  document.getElementById('keyboardDisplay').textContent = '0';
  document.getElementById('keyboardTitle').textContent = 'Valor da Sangria';
  document.getElementById('virtualKeyboard').classList.add('show');
}

function editOtherItem(index) {
  editIndex = index;
  keyboardTarget = 'edit-other';
  keyboardValue = '0';
  isFirstDigit = true;
  
  document.getElementById('keyboardDisplay').textContent = '0';
  document.getElementById('keyboardTitle').textContent = 'Novo Valor de "Outros"';
  document.getElementById('virtualKeyboard').classList.add('show');
}

function selectPaymentType(type) {
  currentPaymentType = type;
  
  if (type === 'cash') {
    document.getElementById('paymentTypeCash').checked = true;
    document.getElementById('paymentTypeExternal').checked = false;
    document.getElementById('paymentTypeMixed').checked = false;
    document.getElementById('mixedPaymentSection').style.display = 'none';
    document.getElementById('cashBalanceInfo').style.display = 'block';
  } else if (type === 'external') {
    document.getElementById('paymentTypeCash').checked = false;
    document.getElementById('paymentTypeExternal').checked = true;
    document.getElementById('paymentTypeMixed').checked = false;
    document.getElementById('mixedPaymentSection').style.display = 'none';
    document.getElementById('cashBalanceInfo').style.display = 'none';
  } else if (type === 'mixed') {
    document.getElementById('paymentTypeCash').checked = false;
    document.getElementById('paymentTypeExternal').checked = false;
    document.getElementById('paymentTypeMixed').checked = true;
    document.getElementById('mixedPaymentSection').style.display = 'block';
    document.getElementById('cashBalanceInfo').style.display = 'block';
    
    document.getElementById('mixedCashValue').value = '';
    document.getElementById('mixedExternalValue').value = '';
    mixedCashAmount = 0;
    mixedExternalAmount = 0;
    updateMixedTotal();
  }
  
  var cashBalance = getCashBalance();
  document.getElementById('currentCashBalance').textContent = 'R$ ' + cashBalance.toFixed(2).replace('.', ',');
}

function openMixedCashKeyboard() {
  keyboardTarget = 'mixed-cash';
  keyboardValue = '0';
  isFirstDigit = true;
  document.getElementById('keyboardDisplay').textContent = 'R$ 0';
  document.getElementById('keyboardTitle').textContent = 'Valor do Caixa';
  document.getElementById('virtualKeyboard').classList.add('show');
}

function openMixedExternalKeyboard() {
  keyboardTarget = 'mixed-external';
  keyboardValue = '0';
  isFirstDigit = true;
  document.getElementById('keyboardDisplay').textContent = 'R$ 0';
  document.getElementById('keyboardTitle').textContent = 'Valor Externo';
  document.getElementById('virtualKeyboard').classList.add('show');
}

function updateMixedTotal() {
  var total = mixedCashAmount + mixedExternalAmount;
  document.getElementById('mixedTotal').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
  
  var paymentValueStr = document.getElementById('paymentValue').value;
  if (paymentValueStr) {
    var expectedTotal = parseFloat(paymentValueStr.replace('R$ ', '').replace(',', '.'));
    if (Math.abs(total - expectedTotal) > 0.01) {
      document.getElementById('mixedWarning').style.display = 'block';
    } else {
      document.getElementById('mixedWarning').style.display = 'none';
    }
  }
}

function inputDigit(digit) {
  if (isFirstDigit && keyboardValue === '0') {
    keyboardValue = digit;
    isFirstDigit = false;
  } else {
    keyboardValue += digit;
  }
  
  updateKeyboardDisplay();
}

function inputComma() {
  if (keyboardValue.indexOf(',') === -1) {
    keyboardValue += ',';
    isFirstDigit = false;
  }
  updateKeyboardDisplay();
}

function backspace() {
  if (keyboardValue.length > 1) {
    keyboardValue = keyboardValue.slice(0, -1);
  } else {
    keyboardValue = '0';
    isFirstDigit = true;
  }
  updateKeyboardDisplay();
}

function updateKeyboardDisplay() {
  var display = document.getElementById('keyboardDisplay');
  
  if (keyboardTarget === 'edit-quantity') {
    display.textContent = keyboardValue + 'x';
  } else if (keyboardTarget === 'others' || keyboardTarget === 'edit-other' || 
      keyboardTarget === 'payment' || keyboardTarget === 'withdrawal' || 
      keyboardTarget === 'received' || keyboardTarget === 'mixed-cash' || 
      keyboardTarget === 'mixed-external') {
    display.textContent = 'R$ ' + keyboardValue;
  } else {
    display.textContent = keyboardValue;
  }
}

function confirmKeyboard() {
  var value = parseFloat(keyboardValue.replace(',', '.'));
  
  if (isNaN(value) || value <= 0) {
    showNotification('Insira um valor v√°lido', 'error');
    return;
  }
  
  if (keyboardTarget === 'edit-quantity') {
    var quantity = parseInt(keyboardValue);
    if (quantity > 0) {
      cart[editIndex].quantity = quantity;
      cart[editIndex].total = cart[editIndex].quantity * cart[editIndex].price;
      updateCart();
    }
  } else if (keyboardTarget === 'others') {
    cart.unshift({
      name: 'Outros',
      price: value,
      quantity: 1,
      total: value,
      isOther: true
    });
    updateCart();
  } else if (keyboardTarget === 'edit-other') {
    cart[editIndex].price = value;
    cart[editIndex].total = value * cart[editIndex].quantity;
    updateCart();
  } else if (keyboardTarget === 'received') {
    receivedAmount = value;
    document.getElementById('receivedInput').value = 'R$ ' + value.toFixed(2).replace('.', ',');
    calculateChange(value);
  } else if (keyboardTarget === 'payment') {
    document.getElementById('paymentValue').value = 'R$ ' + value.toFixed(2).replace('.', ',');
    if (currentPaymentType === 'mixed') {
      updateMixedTotal();
    }
  } else if (keyboardTarget === 'withdrawal') {
    document.getElementById('withdrawalValue').value = 'R$ ' + value.toFixed(2).replace('.', ',');
  } else if (keyboardTarget === 'mixed-cash') {
    mixedCashAmount = value;
    document.getElementById('mixedCashValue').value = 'R$ ' + value.toFixed(2).replace('.', ',');
    updateMixedTotal();
  } else if (keyboardTarget === 'mixed-external') {
    mixedExternalAmount = value;
    document.getElementById('mixedExternalValue').value = 'R$ ' + value.toFixed(2).replace('.', ',');
    updateMixedTotal();
  }
  
  closeKeyboard();
}

function closeKeyboard() {
  document.getElementById('virtualKeyboard').classList.remove('show');
  keyboardValue = '';
  keyboardTarget = null;
  editIndex = null;
}

function calculateChange(received) {
  if (!received) received = receivedAmount;
  
  var change = received - total;
  var changeDiv = document.getElementById('changeAmount');
  
  if (change >= 0) {
    changeDiv.textContent = 'Troco: R$ ' + change.toFixed(2).replace('.', ',');
    changeDiv.style.color = '#28a745';
    changeDiv.style.display = 'block';
  } else {
    changeDiv.textContent = 'Valor insuficiente!';
    changeDiv.style.color = '#E53935';
    changeDiv.style.display = 'block';
  }
}

function updateCardDisplay() {
  var receivedSection = document.getElementById('receivedSection');
  
  var existingCardDisplay = document.querySelector('.card-total-display');
  if (existingCardDisplay) {
    existingCardDisplay.remove();
  }
  
  if (paymentMethod === 'Card/PIX') {
    var cardDisplay = document.createElement('div');
    cardDisplay.className = 'card-total-display';
    cardDisplay.textContent = 'Total: R$ ' + total.toFixed(2).replace('.', ',');
    receivedSection.appendChild(cardDisplay);
  }
}

function updateCart() {
  var summaryList = document.getElementById('summaryList');
  
  if (cart.length === 0) {
    summaryList.innerHTML = '<div class="empty-cart"><i class="fas fa-shopping-cart"></i><p>Nenhum item adicionado</p></div>';
  } else {
    var html = '';
    for (var i = 0; i < cart.length; i++) {
      var item = cart[i];
      var itemClass = item.isOther ? 'is-others' : '';
      html += '<div class="summary-item ' + itemClass + '" onclick="editItemQuantity(' + i + ')">';
      html += '<div>';
      html += '<div class="item-label">' + item.name + '</div>';
      html += '<div class="item-quantity">' + item.quantity + 'x R$ ' + item.price.toFixed(2).replace('.', ',') + '</div>';
      html += '</div>';
      html += '<div class="item-price">R$ ' + item.total.toFixed(2).replace('.', ',') + '</div>';
      html += '<button class="delete-btn" onclick="event.stopPropagation(); removeItem(' + i + ')"><i class="fas fa-trash"></i></button>';
      html += '</div>';
    }
    summaryList.innerHTML = html;
  }
  
  total = 0;
  for (var i = 0; i < cart.length; i++) {
    total += cart[i].total;
  }
  document.getElementById('totalAmount').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
  
  if (paymentMethod === 'Card/PIX') {
    updateCardDisplay();
  }
  
  if (paymentMethod === 'Cash' && receivedAmount > 0) {
    calculateChange(receivedAmount);
  }
}

function removeItem(index) {
  cart.splice(index, 1);
  updateCart();
}

function selectPayment(method) {
  paymentMethod = method;
  
  var buttons = document.querySelectorAll('.payment-btn');
  for (var i = 0; i < buttons