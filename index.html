
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caixa Freitas v9.0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-tap-highlight-color:transparent}
body{font-family:Inter,sans-serif;background:#1a1a2e;color:#2c3e50;height:100vh;overflow:hidden}
button{cursor:pointer;border:none;transition:.3s}
button:active{transform:scale(.97)}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.turn-selection{position:fixed;inset:0;background:linear-gradient(135deg,#4a1a2e,#2d0f1c);display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;padding:20px;z-index:1000}
.turn-logo{width:90px;height:90px;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:2.8rem;font-weight:800;margin-bottom:24px}
.turn-title{font-size:2rem;font-weight:800;margin-bottom:12px;text-align:center}
.turn-subtitle{font-size:1.05rem;opacity:.9;margin-bottom:36px;text-align:center}
.turn-btn{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.25);color:#fff;padding:20px 28px;border-radius:16px;font-size:1.15rem;font-weight:700;margin:0 8px}
#mainApp{display:none;flex-direction:column;height:100vh}
#mainApp.show{display:flex;animation:fadeIn .5s}
.header{background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;padding:12px;text-align:center}
.header h1{font-size:1.5rem;font-weight:800}
.turno-info{font-size:.8rem;background:rgba(255,255,255,.2);padding:4px 12px;border-radius:12px;margin-top:8px;display:inline-flex;gap:6px;align-items:center}
.container{max-width:420px;margin:0 auto;padding:8px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
.card{background:rgba(255,255,255,.95);border-radius:16px;padding:14px;box-shadow:0 8px 32px rgba(0,0,0,.12);animation:slideUp .5s}
.section-title{font-size:1rem;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.products-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.product-btn{background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;border-radius:12px;padding:18px 12px;font-size:.95rem;font-weight:700;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px}
.product-btn .price{font-size:.8rem;opacity:.95}
.others-btn{background:linear-gradient(135deg,#FF9800,#F57C00)}
.summary-list{min-height:120px;max-height:150px;overflow-y:auto;margin-bottom:12px;border:1px solid #dee2e6;border-radius:12px;padding:8px;background:rgba(248,249,250,.5)}
.summary-item{display:grid;grid-template-columns:1fr auto auto;gap:10px;padding:12px;margin-bottom:6px;background:#fff;border-radius:12px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:.3s}
.summary-item:hover{transform:translateX(-3px)}
.summary-item.is-others{background:linear-gradient(135deg,rgba(255,249,196,.9),rgba(255,245,157,.9))}
.item-label{font-weight:700;font-size:.9rem}
.item-quantity{font-size:.8rem;color:#6c757d;margin-top:2px}
.item-price{font-weight:800;color:#4a1a2e;font-size:.95rem}
.delete-btn{background:none;color:#E53935;padding:8px;border-radius:50%;width:36px;height:36px;font-size:.9rem}
.delete-btn:hover{background:rgba(229,57,53,.1)}
.empty-cart{text-align:center;padding:24px;color:#6c757d}
.empty-cart i{font-size:2.5rem;opacity:.3;margin-bottom:12px;display:block}
.total-amount{font-size:1.5rem;font-weight:900;color:#4a1a2e;text-align:center;margin-bottom:14px;border:2px solid #4a1a2e;border-radius:12px;padding:12px;background:#fff}
.payment-methods{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.payment-btn{background:#fff;color:#2c3e50;border:2px solid #dee2e6;border-radius:12px;padding:14px;font-weight:700;display:flex;align-items:center;gap:8px;justify-content:center;font-size:.95rem;transition:.3s}
.payment-btn:hover{transform:translateY(-2px)}
.payment-btn.selected{background:linear-gradient(135deg,#28a745,#218838);color:#fff;border-color:#28a745;transform:scale(1.02)}
.payment-btn.selected.card-selected{background:linear-gradient(135deg,#007bff,#0056b3);border-color:#007bff}
.received-section{margin-bottom:14px;display:none}
.received-section.show{display:block;animation:slideUp .4s}
.received-input{width:100%;padding:14px;font-size:1.3rem;border:2px solid #F9A825;border-radius:12px;text-align:center;background:linear-gradient(135deg,rgba(255,249,196,.9),rgba(255,245,157,.9));font-weight:800;cursor:pointer}
.card-total-display{width:100%;padding:14px;font-size:1.3rem;border:2px solid #007bff;border-radius:12px;text-align:center;background:linear-gradient(135deg,rgba(0,123,255,.1),rgba(0,86,179,.1));font-weight:800;color:#007bff;pointer-events:none}
.change-amount{text-align:center;font-size:1.15rem;font-weight:800;color:#28a745;margin-top:10px;display:none}
.action-buttons{display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px;margin-bottom:14px}
.action-buttons-row2{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
.action-btn{padding:14px 10px;border-radius:12px;font-size:.9rem;font-weight:800;display:flex;align-items:center;justify-content:center;gap:6px;min-height:54px;transition:.3s}
.action-btn:hover{transform:translateY(-2px)}
.next-btn{background:linear-gradient(135deg,#28a745,#218838);color:#fff;font-size:1rem}
.clear-btn{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff}
.payment-supplier-btn{background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;font-size:.8rem}
.sangria-btn{background:linear-gradient(135deg,#FF9800,#F57C00);color:#fff;font-size:.8rem}
.close-turn-btn{background:linear-gradient(135deg,#6c757d,#424242);color:#fff;font-size:.8rem}
.history-btn{background:linear-gradient(135deg,#6c757d,#424242);color:#fff;font-size:.85rem}
.history-btn.pro{background:linear-gradient(135deg,#4a1a2e,#2d0f1c)}
.modal-overlay{position:fixed;inset:0;background:rgba(26,26,46,.95);backdrop-filter:blur(20px);padding:20px;z-index:2000;display:none;justify-content:center;align-items:center;overflow-y:auto}
.modal-overlay.show{display:flex;animation:fadeIn .4s}
.modal-content{background:#fff;border-radius:24px;padding:24px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #dee2e6}
.modal-title{font-weight:800;font-size:1.4rem;display:flex;align-items:center;gap:10px}
.modal-close{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff;font-size:1.3rem;padding:8px 12px;border-radius:10px;font-weight:bold}
.form-group{margin-bottom:18px}
.form-label{display:block;font-weight:700;margin-bottom:8px;font-size:.95rem}
.form-input{width:100%;padding:14px;border:2px solid #dee2e6;border-radius:12px;font-size:1rem;transition:.3s}
.form-input:focus{outline:none;border-color:#4a1a2e;box-shadow:0 0 0 3px rgba(74,26,46,.1)}
.form-checkbox{display:flex;align-items:center;gap:10px;padding:14px;background:#f8f9fa;border-radius:12px;border:2px solid #dee2e6;cursor:pointer;transition:.3s}
.form-checkbox:hover{background:#fff3cd;border-color:#FF9800}
.form-checkbox.payment-type-option{justify-content:center}
.form-checkbox input{width:24px;height:24px;cursor:pointer}
.form-checkbox label{font-weight:700;flex:1;cursor:pointer}
.form-actions{display:grid;grid-template-columns:1fr 2fr;gap:12px;margin-top:24px}
.btn-cancel{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff;padding:16px;border-radius:12px;font-weight:800;font-size:1rem}
.btn-submit{background:linear-gradient(135deg,#28a745,#218838);color:#fff;padding:16px;border-radius:12px;font-weight:800;font-size:1rem}
.virtual-keyboard{position:fixed;inset:0;background:rgba(26,26,46,.95);backdrop-filter:blur(20px);padding:20px;z-index:3000;display:none;justify-content:center;align-items:center}
.virtual-keyboard.show{display:flex;animation:fadeIn .4s}
.keyboard-container{background:#fff;border-radius:24px;padding:24px;width:100%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.keyboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #dee2e6}
.keyboard-title{font-weight:800;font-size:1.15rem}
.keyboard-close{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff;font-size:1.3rem;padding:8px 12px;border-radius:10px;font-weight:bold}
.keyboard-display{background:linear-gradient(135deg,rgba(255,249,196,.9),rgba(255,245,157,.9));padding:18px;border-radius:12px;font-size:2rem;font-weight:900;text-align:center;margin-bottom:20px;border:3px solid #F9A825;min-height:75px;display:flex;align-items:center;justify-content:center;color:#4a1a2e}
.keyboard-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.keyboard-btn{aspect-ratio:1;font-size:1.5rem;font-weight:800;border-radius:12px;background:linear-gradient(135deg,#4a1a2e,#2d0f1c);color:#fff;min-height:64px;display:flex;align-items:center;justify-content:center}
.keyboard-actions{display:grid;grid-template-columns:1fr 2fr;gap:12px}
.keyboard-cancel,.keyboard-confirm{border-radius:12px;padding:18px;font-weight:800;font-size:1.05rem}
.keyboard-cancel{background:linear-gradient(135deg,#E53935,#d32f2f);color:#fff}
.keyboard-confirm{background:linear-gradient(135deg,#28a745,#218838);color:#fff}
.notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#fff;border-radius:16px;padding:18px 24px;box-shadow:0 8px 32px rgba(0,0,0,.2);z-index:3000;display:none;align-items:center;gap:14px;min-width:300px}
.notification.show{display:flex;animation:slideUp .5s}
.notification.error{border-left:4px solid #E53935;background:rgba(253,242,242,.98)}
.notification.warning{border-left:4px solid #FF9800;background:rgba(255,251,240,.98)}
.notification.success{border-left:4px solid #28a745;background:rgba(232,245,233,.98)}
.notification-icon{font-size:1.5rem}
.notification.error .notification-icon{color:#E53935}
.notification.warning .notification-icon{color:#FF9800}
.notification.success .notification-icon{color:#28a745}
.notification-message{flex:1;font-weight:700;font-size:1rem}
</style>
</head>
<body>

<div class="turn-selection" id="turnSelection">
<div class="turn-logo">F</div>
<h2 class="turn-title">Bem-vindo ao Caixa Freitas</h2>
<p class="turn-subtitle">Selecione o turno para começar</p>
<div>
<button class="turn-btn" onclick="startTurn('morning')">☀️ Turno da Manhã</button>
<button class="turn-btn" onclick="startTurn('afternoon')">🌅 Turno da Tarde</button>
</div>
</div>

<div id="mainApp">
<header class="header">
<h1>Caixa Freitas</h1>
<div class="turno-info">
<i class="fas fa-clock"></i>
<span id="turnText">Carregando...</span>
</div>
</header>

<div class="container">
<section class="card">
<h3 class="section-title"><i class="fas fa-bread-slice"></i> Produtos</h3>
<div class="products-grid">
<button class="product-btn" onclick="addProduct('Pão de Sal', 0.70)">
<span>Pão de Sal</span>
<span class="price">R$ 0,70</span>
</button>
<button class="product-btn" onclick="addProduct('Pão Doce Comum', 0.70)">
<span>Pão Doce Comum</span>
<span class="price">R$ 0,70</span>
</button>
<button class="product-btn" onclick="addProduct('Pão Doce Especial', 0.80)">
<span>Pão Doce Especial</span>
<span class="price">R$ 0,80</span>
</button>
<button class="product-btn others-btn" onclick="openKeyboard('others')">
<span>Outros</span>
</button>
</div>
</section>

<section class="card">
<h3 class="section-title"><i class="fas fa-shopping-cart"></i> Pedido</h3>
<div class="summary-list" id="summaryList">
<div class="empty-cart">
<i class="fas fa-shopping-cart"></i>
<p>Nenhum item adicionado</p>
</div>
</div>

<div class="total-amount">
Total: <span id="totalAmount">R$ 0,00</span>
</div>

<h4 class="section-title"><i class="fas fa-credit-card"></i> Pagamento</h4>
<div class="payment-methods">
<button class="payment-btn" onclick="selectPayment('Cash', event)">
<i class="fas fa-money-bill-wave"></i> Dinheiro
</button>
<button class="payment-btn" onclick="selectPayment('Card/PIX', event)">
<i class="fas fa-credit-card"></i> Cartão/PIX
</button>
</div>

<div class="received-section" id="receivedSection">
<input type="text" class="received-input" id="receivedInput" placeholder="Valor recebido" readonly onclick="openReceivedKeyboard()">
<div class="change-amount" id="changeAmount"></div>
</div>

<div class="action-buttons">
<button class="action-btn next-btn" onclick="processNext()">
<i class="fas fa-check"></i> Próximo Cliente
</button>
<button class="action-btn clear-btn" onclick="clearCart()">
<i class="fas fa-trash"></i> Limpar
</button>
<button class="action-btn payment-supplier-btn" onclick="alert('Em desenvolvimento')">
<i class="fas fa-hand-holding-usd"></i> Pagamento
</button>
</div>

<div class="action-buttons-row2">
<button class="action-btn sangria-btn" onclick="alert('Em desenvolvimento')">
<i class="fas fa-money-bill-wave"></i> Sangria
</button>
<button class="action-btn close-turn-btn" onclick="closeTurn()">
<i class="fas fa-times"></i> Fechar
</button>
<button class="action-btn history-btn" onclick="alert('Em desenvolvimento')">
<i class="fas fa-history"></i> Histórico
</button>
<button class="action-btn history-btn pro" onclick="alert('Em desenvolvimento')">
<i class="fas fa-chart-line"></i> Pro
</button>
</div>
</section>
</div>
</div>

<div class="virtual-keyboard" id="virtualKeyboard">
<div class="keyboard-container">
<div class="keyboard-header">
<span class="keyboard-title" id="keyboardTitle">Inserir valor</span>
<button class="keyboard-close" onclick="closeKeyboard()">×</button>
</div>
<div class="keyboard-display" id="keyboardDisplay">0</div>
<div class="keyboard-grid">
<button class="keyboard-btn" onclick="inputDigit('1')">1</button>
<button class="keyboard-btn" onclick="inputDigit('2')">2</button>
<button class="keyboard-btn" onclick="inputDigit('3')">3</button>
<button class="keyboard-btn" onclick="inputDigit('4')">4</button>
<button class="keyboard-btn" onclick="inputDigit('5')">5</button>
<button class="keyboard-btn" onclick="inputDigit('6')">6</button>
<button class="keyboard-btn" onclick="inputDigit('7')">7</button>
<button class="keyboard-btn" onclick="inputDigit('8')">8</button>
<button class="keyboard-btn" onclick="inputDigit('9')">9</button>
<button class="keyboard-btn" onclick="inputComma()">,</button>
<button class="keyboard-btn" onclick="inputDigit('0')">0</button>
<button class="keyboard-btn" onclick="backspace()">
<i class="fas fa-backspace"></i>
</button>
</div>
<div class="keyboard-actions">
<button class="keyboard-cancel" onclick="closeKeyboard()">Cancelar</button>
<button class="keyboard-confirm" onclick="confirmKeyboard()">Confirmar</button>
</div>
</div>
</div>

<div class="notification" id="notification">
<i class="notification-icon fas fa-exclamation-triangle"></i>
<span class="notification-message" id="notificationMessage">Mensagem</span>
</div>

<script>
var cart = [];
var total = 0;
var paymentMethod = '';
var currentTurn = null;
var keyboardValue = '';
var keyboardTarget = null;
var isFirstDigit = false;
var receivedAmount = 0;

var turnsData = {
  morning: { totalCash: 0, totalCard: 0, history: [] },
  afternoon: { totalCash: 0, totalCard: 0, history: [] }
};

function startTurn(type) {
  currentTurn = {
    type: type,
    name: type === 'morning' ? '☀️ Turno da Manhã' : '🌅 Turno da Tarde',
    startTime: new Date().toLocaleTimeString('pt-BR')
  };
  
  document.getElementById('turnSelection').style.display = 'none';
  document.getElementById('mainApp').classList.add('show');
  document.getElementById('turnText').textContent = currentTurn.name + ' - ' + currentTurn.startTime;
}

function addProduct(name, price) {
  var existing = cart.find(function(item) { return item.name === name && !item.isOther; });
  
  if (existing) {
    existing.quantity++;
    existing.total = existing.quantity * existing.price;
  } else {
    cart.unshift({ name: name, price: price, quantity: 1, total: price, isOther: false });
  }
  
  updateCart();
}

function updateCart() {
  var list = document.getElementById('summaryList');
  
  if (cart.length === 0) {
    list.innerHTML = '<div class="empty-cart"><i class="fas fa-shopping-cart"></i><p>Nenhum item adicionado</p></div>';
  } else {
    var html = '';
    for (var i = 0; i < cart.length; i++) {
      var item = cart[i];
      html += '<div class="summary-item' + (item.isOther ? ' is-others' : '') + '" onclick="editItem(' + i + ')">';
      html += '<div><div class="item-label">' + item.name + '</div>';
      html += '<div class="item-quantity">' + item.quantity + 'x R$ ' + item.price.toFixed(2).replace('.', ',') + '</div></div>';
      html += '<div class="item-price">R$ ' + item.total.toFixed(2).replace('.', ',') + '</div>';
      html += '<button class="delete-btn" onclick="event.stopPropagation(); removeItem(' + i + ')"><i class="fas fa-trash"></i></button>';
      html += '</div>';
    }
    list.innerHTML = html;
  }
  
  total = 0;
  for (var i = 0; i < cart.length; i++) total += cart[i].total;
  document.getElementById('totalAmount').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
  
  if (paymentMethod === 'Card/PIX') updateCardDisplay();
  if (paymentMethod === 'Cash' && receivedAmount > 0) calculateChange();
}

function removeItem(index) {
  cart.splice(index, 1);
  updateCart();
}

function editItem(index) {
  alert('Clique para editar quantidade (em desenvolvimento)');
}

function selectPayment(method, evt) {
  paymentMethod = method;
  
  var btns = document.querySelectorAll('.payment-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].classList.remove('selected', 'card-selected');
  }
  
  evt.target.closest('.payment-btn').classList.add('selected');
  
  var section = document.getElementById('receivedSection');
  var existing = document.querySelector('.card-total-display');
  if (existing) existing.remove();
  
  if (method === 'Cash') {
    section.classList.add('show');
    document.getElementById('receivedInput').style.display = 'block';
  } else {
    section.classList.add('show');
    document.getElementById('receivedInput').style.display = 'none';
    document.getElementById('changeAmount').style.display = 'none';
    evt.target.closest('.payment-btn').classList.add('card-selected');
    
    var display = document.createElement('div');
    display.className = 'card-total-display';
    display.textContent = 'Total: R$ ' + total.toFixed(2).replace('.', ',');
    section.appendChild(display);
  }
}

function openKeyboard(target) {
  keyboardTarget = target;
  keyboardValue = '0';
  isFirstDigit = true;
  document.getElementById('keyboardDisplay').textContent = '0';
  document.getElementById('keyboardTitle').textContent = target === 'others' ? 'Valor de "Outros"' : 'Inserir valor';
  document.getElementById('virtualKeyboard').classList.add('show');
}

function openReceivedKeyboard() {
  if (!paymentMethod) {
    showNotification('Selecione um método de pagamento primeiro', 'warning');
    return;
  }
  if (paymentMethod !== 'Cash') {
    showNotification('Campo disponível apenas para dinheiro', 'warning');
    return;
  }
  keyboardTarget = 'received';
  keyboardValue = '0';
  isFirstDigit = true;
  document.getElementById('keyboardDisplay').textContent = '0';
  document.getElementById('keyboardTitle').textContent = 'Valor Recebido';
  document.getElementById('virtualKeyboard').classList.add('show');
}

function closeKeyboard() {
  document.getElementById('virtualKeyboard').classList.remove('show');
  keyboardValue = '';
  keyboardTarget = null;
}

function inputDigit(digit) {
  if (isFirstDigit && keyboardValue === '0') {
    keyboardValue = digit;
    isFirstDigit = false;
  } else {
    keyboardValue += digit;
  }
  updateKeyboardDisplay();
}

function inputComma() {
  if (keyboardValue.indexOf(',') === -1) {
    keyboardValue += ',';
    isFirstDigit = false;
  }
  updateKeyboardDisplay();
}

function backspace() {
  if (keyboardValue.length > 1) {
    keyboardValue = keyboardValue.slice(0, -1);
  } else {
    keyboardValue = '0';
    isFirstDigit = true;
  }
  updateKeyboardDisplay();
}

function updateKeyboardDisplay() {
  document.getElementById('keyboardDisplay').textContent = 'R$ ' + keyboardValue;
}

function confirmKeyboard() {
  var value = parseFloat(keyboardValue.replace(',', '.'));
  
  if (isNaN(value) || value <= 0) {
    showNotification('Insira um valor válido', 'error');
    return;
  }
  
  if (keyboardTarget === 'others') {
    cart.unshift({ name: 'Outros', price: value, quantity: 1, total: value, isOther: true });
    updateCart();
  } else if (keyboardTarget === 'received') {
    receivedAmount = value;
    document.getElementById('receivedInput').value = 'R$ ' + value.toFixed(2).replace('.', ',');
    calculateChange();
  }
  
  closeKeyboard();
}

function calculateChange() {
  var change = receivedAmount - total;
  var div = document.getElementById('changeAmount');
  
  if (change >= 0) {
    div.textContent = 'Troco: R$ ' + change.toFixed(2).replace('.', ',');
    div.style.color = '#28a745';
    div.style.display = 'block';
  } else {
    div.textContent = 'Valor insuficiente!';
    div.style.color = '#E53935';
    div.style.display = 'block';
  }
}

function updateCardDisplay() {
  var existing = document.querySelector('.card-total-display');
  if (existing) existing.remove();
  
  if (paymentMethod === 'Card/PIX') {
    var display = document.createElement('div');
    display.className = 'card-total-display';
    display.textContent = 'Total: R$ ' + total.toFixed(2).replace('.', ',');
    document.getElementById('receivedSection').appendChild(display);
  }
}

function processNext() {
  if (cart.length === 0) {
    showNotification('Adicione itens ao carrinho', 'warning');
    return;
  }
  
  if (!paymentMethod) {
    showNotification('Selecione um método de pagamento', 'warning');
    return;
  }
  
  if (paymentMethod === 'Cash') {
    var value = document.getElementById('receivedInput').value;
    if (!value) {
      showNotification('Informe o valor recebido', 'warning');
      return;
    }
    var received = parseFloat(value.replace('R$ ', '').replace(',', '.'));
    if (received < total) {
      showNotification('Valor recebido é insuficiente', 'error');
      return;
    }
  }
  
  var items = [];
  for (var i = 0; i < cart.length; i++) {
    items.push({
      name: cart[i].name,
      quantity: cart[i].quantity,
      price: cart[i].price,
      total: cart[i].total
    });
  }
  
  window.lastCreatedSale = {
    data: new Date().toLocaleDateString('pt-BR'),
    hora: new Date().toLocaleTimeString('pt-BR'),
    turno: currentTurn ? currentTurn.name : 'Não definido',
    items: items,
    total: total,
    pagamento: paymentMethod === 'Cash' ? 'Dinheiro' : 'Cartão/PIX'
  };
  
  var turnData = turnsData[currentTurn.type];
  if (paymentMethod === 'Cash') {
    turnData.totalCash += total;
  } else {
    turnData.totalCard += total;
  }
  
  showNotification('Venda registrada com sucesso! ✔', 'success');
  clearCart();
}

function clearCart() {
  cart = [];
  total = 0;
  paymentMethod = '';
  receivedAmount = 0;
  
  var btns = document.querySelectorAll('.payment-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].classList.remove('selected', 'card-selected');
  }
  
  var existing = document.querySelector('.card-total-display');
  if (existing) existing.remove();
  
  document.getElementById('receivedSection').classList.remove('show');
  document.getElementById('receivedInput').value = '';
  document.getElementById('receivedInput').style.display = 'block';
  document.getElementById('changeAmount').style.display = 'none';
  
  updateCart();
}

function closeTurn() {
  if (!confirm('Deseja fechar o turno atual?')) return;
  
  clearCart();
  document.getElementById('mainApp').classList.remove('show');
  document.getElementById('turnSelection').style.display = 'flex';
}

function showNotification(message, type) {
  var notif = document.getElementById('notification');
  var msg = document.getElementById('notificationMessage');
  var icon = notif.querySelector('.notification-icon');
  
  msg.textContent = message;
  notif.className = 'notification ' + type;
  
  if (type === 'error') {
    icon.className = 'notification-icon fas fa-exclamation-circle';
  } else if (type === 'warning') {
    icon.className = 'notification-icon fas fa-exclamation-triangle';
  } else if (type === 'success') {
    icon.className = 'notification-icon fas fa-check-circle';
  }
  
  notif.classList.add('show');
  
  setTimeout(function() {
    notif.classList.remove('show');
  }, 3000);
}
</script>

<!-- MÓDULO DE SINCRONIZAÇÃO COM GOOGLE SHEETS -->
<script>
(function(){
const API_URL = 'https://script.google.com/macros/s/AKfycbxdXh5kBkQbQ44MLHmZiVG_tBdp-CJ5XVfy7Bq2ep_dOCOMEJEFTcpQrlpbfcp2CZWI/exec';
const DB_NAME = 'caixa_freitas_db';
const DB_VERSION = 1;
let idbDB = null;

function dbInit() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('state')) db.createObjectStore('state');
      if (!db.objectStoreNames.contains('outbox')) db.createObjectStore('outbox', { keyPath: 'id', autoIncrement: true });
    };
    req.onsuccess = (e) => { idbDB = e.target.result; resolve(); };
    req.onerror = (e) => reject(e.target.error);
  });
}

function dbPut(store, key, value) {
  return new Promise((resolve, reject) => {
    const tx = idbDB.transaction([store], 'readwrite');
    const s = tx.objectStore(store);
    const r = s.put(value, key);
    r.onsuccess = () => resolve();
    r.onerror = (ev) => reject(ev.target.error);
  });
}

function dbGet(store, key) {
  return new Promise((resolve, reject) => {
    const tx = idbDB.transaction([store], 'readonly');
    const s = tx.objectStore(store);
    const r = s.get(key);
    r.onsuccess = () => resolve(r.result);
    r.onerror = (ev) => reject(ev.target.error);
  });
}

function dbAddOutbox(item) {
  return new Promise((resolve, reject) => {
    const tx = idbDB.transaction(['outbox'], 'readwrite');
    const s = tx.objectStore('outbox');
    const r = s.add(item);
    r.onsuccess = () => resolve(r.result);
    r.onerror = (ev) => reject(ev.target.error);
  });
}

function dbGetAllOutbox() {
  return new Promise((resolve, reject) => {
    const tx = idbDB.transaction(['outbox'], 'readonly');
    const s = tx.objectStore('outbox');
    const r = s.getAll();
    r.onsuccess = () => resolve(r.result || []);
    r.onerror = (ev) => reject(ev.target.error);
  });
}

function dbDeleteOutbox(id) {
  return new Promise((resolve, reject) => {
    const tx = idbDB.transaction(['outbox'], 'readwrite');
    const s = tx.objectStore('outbox');
    const r = s.delete(id);
    r.onsuccess = () => resolve();
    r.onerror = (ev) => reject(ev.target.error);
  });
}

async function saveAppState() {
  if (!idbDB) return;
  try {
    const state = {
      cart: window.cart || [],
      total: window.total || 0,
      paymentMethod: window.paymentMethod || '',
      turnsData: window.turnsData || {},
      currentTurn: window.currentTurn || null,
      receivedAmount: window.receivedAmount || 0,
      savedAt: new Date().toISOString()
    };
    await dbPut('state', 'appState', state);
  } catch (e) {
    console.warn('[persist] erro ao salvar:', e);
  }
}

async function loadAppState() {
  if (!idbDB) return;
  try {
    const state = await dbGet('state', 'appState');
    if (!state) return;
    
    if (state.cart) window.cart = state.cart;
    if (state.total !== undefined) window.total = state.total;
    if (state.paymentMethod) window.paymentMethod = state.paymentMethod;
    if (state.turnsData) window.turnsData = state.turnsData;
    if (state.currentTurn) window.currentTurn = state.currentTurn;
    if (state.receivedAmount !== undefined) window.receivedAmount = state.receivedAmount;
    
    if (typeof window.updateCart === 'function') {
      window.updateCart();
    }
    
    if (window.currentTurn) {
      document.getElementById('turnSelection').style.display = 'none';
      document.getElementById('mainApp').classList.add('show');
      document.getElementById('turnText').textContent = window.currentTurn.name + ' - ' + window.currentTurn.startTime;
    }
  } catch (e) {
    console.warn('[persist] erro ao carregar:', e);
  }
}

async function enqueueSync(item) {
  if (!idbDB) return;
  try {
    item.createdAt = new Date().toISOString();
    item.synced = false;
    await dbAddOutbox(item);
    console.log('[sync] Item enfileirado:', item.type);
    trySync();
  } catch (e) {
    console.warn('[sync] erro ao enfileirar:', e);
  }
}

let syncRunning = false;
async function trySync() {
  if (!navigator.onLine || !idbDB || syncRunning) return;
  
  syncRunning = true;
  try {
    const items = await dbGetAllOutbox();
    console.log('[sync] Itens pendentes:', items.length);
    
    for (const item of items) {
      try {
        console.log('[sync] Enviando:', item.type);
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item),
          mode: 'no-cors'
        });
        
        await dbDeleteOutbox(item.id);
        console.log('[sync] Item sincronizado:', item.type);
      } catch (err) {
        console.warn('[sync] Erro de rede:', err);
        break;
      }
    }
  } finally {
    syncRunning = false;
  }
}

window.addEventListener('online', () => { 
  console.log('[sync] Conexão restaurada');
  trySync(); 
});

setInterval(() => { trySync(); }, 60000);

async function init() {
  try {
    await dbInit();
    console.log('[sync] IndexedDB inicializado');
    await loadAppState();
    console.log('[sync] Estado carregado');
    trySync();
  } catch (err) {
    console.warn('[sync] Erro na inicialização:', err);
  }
}

document.addEventListener('DOMContentLoaded', init);

const originalProcessNext = window.processNext;
window.processNext = function() {
  originalProcessNext.apply(this, arguments);
  
  if (window.lastCreatedSale) {
    console.log('[sync] Enfileirando venda');
    enqueueSync({ type: 'sale', payload: window.lastCreatedSale }).catch(e => console.error(e));
  }
  
  saveAppState().catch(e => console.error(e));
};

const originalAddProduct = window.addProduct;
window.addProduct = function() {
  originalAddProduct.apply(this, arguments);
  saveAppState().catch(e => console.error(e));
};

const originalStartTurn = window.startTurn;
window.startTurn = function() {
  originalStartTurn.apply(this, arguments);
  saveAppState().catch(e => console.error(e));
};

console.log('[sync] Sistema carregado - URL:', API_URL);

})();
</script>

</body>
</html>
